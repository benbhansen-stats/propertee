---
title: "Non-Binary Treatment"
date: "`r Sys.Date()`"
output: html_document
---

```{r, include = FALSE}
setwd("~/repositories/R/flexida")
devtools::load_all()
```

Binary treatments are straightforward:

```{r}
des1 <- rct_design(z ~ cluster(cid1, cid2), data = simdata)
ate(des1, data = simdata)
```

We now allow non-binary treatment as well:

```{r}
simdata$dose
des2 <- rct_design(dose ~ cluster(cid1, cid2), data = simdata)
```

Proceeding with this treatment will cause an error:

```{r, error = TRUE}
ate(des2, data = simdata)
```

Instead, we pass a `dichotomize` argument:

```{r}
ate(des2, data = simdata,
    dichotomize = dose < 200 ~ dose >= 200)
ate(des2, data = simdata,
    dichotomize = dose > 200 | dose < 100 ~ .)
ate(des2, data = simdata,
    dichotomize = . ~ dose %in% c(50, 300))
ate(des2, data = simdata,
    dichotomize = dose <= 100 ~ dose == 300)
```

Alternatively, we could place the dichotomization in the Design instead.

```{r}
dichotomization(des2) <- dose >= 200 ~ dose < 100
ate(des2, data = simdata)
des3 <- rct_design(dose ~ cluster(cid1, cid2), data = simdata,
                   dichotomize = dose >= 200 ~ dose < 100)
ate(des3, data = simdata)
```
## Storage of non-binary treatment

When a design's treatment is dichotomized, we keep the orignal treatment in
place, but add a slot for the dichotomization

```{r}
des2@structure
des2@dichotomization
```

We can then evaluate this dichotomization with either of the two functions
(`treatment()` being user-facing, `.bin_txt()` being internal)

```{r}
treatment(des2)
treatment(des2, binary = TRUE)
.bin_txt(des2)
```


## `WeightedDesign`

This ensures that the `@Design` slot inside a `WeightedDesign` object has a
binary 0/1 treatment either through a direct 0/1 treatment, or the presence of a
`dichotomization` slot.

```{r}
wght <- ate(des2, data = simdata)
.bin_txt(wght@Design)
```

There are two helper functions to check this:

```{r}
is_dichotomized(des1)
has_binary_treatment(des1)
is_dichotomized(des2)
has_binary_treatment(des2)
```
