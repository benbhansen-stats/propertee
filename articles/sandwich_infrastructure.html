<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model • propertee</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">propertee</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Basic</h6></li>
    <li><a class="dropdown-item" href="../articles/intro-to-propertee.html">Introduction to propertee</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/not-for-cran/mi_vignette/demo.html">Real-data demonstration with a finely stratified cluster RCT and a broader administrative database</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/non-binary-treatment.html">Non-binary Treatment Specification</a></li>
    <li><a class="dropdown-item" href="../articles/RDD.html">Regression Discontinuity Designs</a></li>
    <li><a class="dropdown-item" href="../articles/not-for-cran/geex_vs_propertee.html">propertee vs. geex</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Theory</h6></li>
    <li><a class="dropdown-item" href="../articles/sandwich_infrastructure.html">Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</a></li>
    <li><a class="dropdown-item" href="../articles/LinearModelVarianceEstimation.html">Variance Estimation Testing Using A Simple Linear Specification</a></li>
    <li><a class="dropdown-item" href="../articles/design_based_SEs.html">Design based sandwich SEs for differences of Hajek estimators</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/benbhansen-stats/propertee/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</h1>
                        <h4 data-toc-skip class="author">Ben Hansen</h4>
            
            <h4 data-toc-skip class="date">April 2022 (+ subsequent
non-substantive updates)</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/benbhansen-stats/propertee/blob/main/vignettes/sandwich_infrastructure.Rmd" class="external-link"><code>vignettes/sandwich_infrastructure.Rmd</code></a></small>
      <div class="d-none name"><code>sandwich_infrastructure.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="context">Context<a class="anchor" aria-label="anchor" href="#context"></a>
</h2>
<p>The user has specified a comparative study design and separately
fitted a covariance model. E.g.:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Design_objects.html">obs_design</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="fu">strata</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/DesignSpecials.html">cluster</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">classroom</span><span class="op">)</span>,</span>
<span>                  data <span class="op">=</span><span class="va">Q_</span><span class="op">)</span></span>
<span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">promotion</span> <span class="op">~</span> <span class="va">pretest</span> <span class="op">+</span> <span class="va">gender</span>,</span>
<span>            family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">C</span><span class="op">)</span></span></code></pre></div>
<p>The data frames <code>C</code> and <code>Q_</code> describe the
covariance and quasiexperimental samples, potentially at different
levels of aggregation. For instance <code>C</code> might give student
data while <code>Q_</code> is a table of classrooms. The samples they
describe may be disjoint, identical or overlapping.</p>
<p>Next she uses <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> (or propertee’s
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>-wrapper, <code><a href="../reference/lmitt.html">lmitt()</a></code>) to calculate directly
adjusted<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Much or all of what’s said here can later be made to
apply with intention-to-treat models of nearby forms, for example
&lt;code&gt;lm(promotion ~ treat + cov_adj(covmod), data=Q, weights=ate(des))&lt;/code&gt;
or &lt;code&gt;lm(promotion ~ treat * cov_adj(covmod), &amp;lt;...&amp;gt;)&lt;/code&gt;.
But for now our focus is covariance modeling followed by direct
adjustment, ie what’s shown in the display.&lt;/p&gt;"><sup>1</sup></a>
estimates of an intention-to-treat effect:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">promotion</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">gender</span>, data <span class="op">=</span> <span class="va">Q</span>,</span>
<span>        offset <span class="op">=</span> <span class="fu"><a href="../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span>,</span>
<span>        weights <span class="op">=</span> <span class="fu"><a href="../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="co"># spits out effect estimates</span></span></code></pre></div>
<p>where <code>Q</code> may be the same as <code>Q_</code>, or
<code>Q_</code> may describe aggregates of units described in
<code>Q</code>; the offset is similar to what
<code>predict(cmod, newdata=Q, type="response")</code> would have given;
and the weights are of the Horwitz-Thompson, inverse probability of
assignment type.</p>
<p>At this point <code>m</code> has class <code>lm</code>, but with
additional information tucked away in <code>m[['model']]</code>: this
data frame will have special columns <code>(weights)</code> and
<code>offset(cov_adj(cmod))</code>. The <strong>propertee</strong>
package implements an S4 class <code>WeightedDesign</code> that extends
the base numeric vector type and encodes information beyond unit weights
necessary for standard error calculations, and arranges that
<code>m[['model']][['(weights)']]</code> is of this type. This note
describes two classes appropriate for
<code>m[['model']][['offset(cov_adj(cmod))']]</code>:
<code>SandwichLayer</code>, and a fallback option
<code>PreSandwichLayer</code>, for use when the call to
<code><a href="../reference/cov_adj.html">cov_adj()</a></code> producing this object is able to locate some but
not all of the necessary information.</p>
<p>Standard errors will be obtained through subsequent steps, e.g.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_lmitt.html">as.teeMod</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_lmitt.html">as.teeMod</a></span><span class="op">(</span><span class="va">m</span>,</span>
<span>                       by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cmod<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>uoa1<span class="op">=</span><span class="va">altuoa1</span>, uoa2<span class="op">=</span><span class="va">altuoa2</span><span class="op">)</span><span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>with “<code>uoa1</code>” and “<code>uoa2</code>” the column names of
<code>clusters(des)</code>, while <code>altuoa1</code> and
<code>altuoa2</code> corresponding column names of <code>C</code>,
or</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_lmitt.html">as.teeMod</a></span><span class="op">(</span><span class="va">m</span>,</span>
<span>                       by<span class="op">=</span><span class="va">keys_data_frame</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>where <code>keys_data_frame</code> has rows aligned with those of
<code>C</code> and columns including “<code>uoa1</code>” and
“<code>uoa2</code>”.</p>
<p>Either way, once <code>m</code> has been coerced to class
<code>teeMod</code>, it has acquired a <code>@Design</code> slot for the
information in <code>des</code>, while <code>m[['model']]</code> will
have a column <code>offset(cov_adj(cmod))</code> of class
<code>SandwichLayer</code>. Together these objects will contain the
necessary additional information to perform standard error calculations
that:</p>
<ul>
<li>attend to the structure of the design, as recorded in
<code>des</code>; and</li>
<li>propagate errors from the fitting of covariance model
<code>cmod</code> into standard errors reported for
<code>treat * gender</code> coefficients.</li>
</ul>
</div>
<div class="section level2">
<h2 id="formal-class-structure-proposal">Formal class structure proposal<a class="anchor" aria-label="anchor" href="#formal-class-structure-proposal"></a>
</h2>
<!-- couldn't get the below to render properly-->
<!-- Rendering from https://mermaid.live/ -->
<p><img src="images/sandwich_layers.png"></p>
<p>Like the existing class <code>WeightedDesign</code>, the
<code>PreSandwichLayer</code> and <code>SandwichLayer</code> classes
extend the base numeric vector type, with numeric vectors (of
predictions) in their <code>@.Data</code> slots.
<code>PreSandwichLayer</code> and <code>SandwichLayer</code> also have a
<code>@prediction_gradient</code> slot, for a numeric matrix of
dimension</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">nrow</span>(<span class="sc">@</span>.Data), <span class="fu">length</span>(<span class="fu">coef</span>(fitted_covariance_model)))</span></code></pre></div>
<p>Regarding <code><a href="../reference/as.SandwichLayer.html">as.SandwichLayer()</a></code>: Turning a
<code>PreSandwichLayer</code>, <code>x</code>, into a
<code>SandwichLayer</code> amounts to providing a mapping from the rows
of <code>model.matrix(x)</code> or <code>sandwich::estfun(x)</code> to
units of assignment recorded in <code>des</code>. This mapping is to be
recorded in the <code>@keys</code> data frame, which has as many rows as
<code>model.matrix(x)</code> and columns storing unit-of-assignment
(clustering) information as well as a Boolean variable indicating
whether such unit of assignments could be found in <code>des</code>.</p>
<p>The mapping can be effected via
<code>expand.model.frame(x, vars, &lt;...&gt;)</code>. If
<code>by=NULL</code>, then <code>vars</code> is the vector of names of
unit-of-assignment variables given in the <code>design</code>,
<code>desvars</code> say. Otherwise <code>by</code> is a named character
vector giving a crosswalk, the second argument to
<code><a href="https://rdrr.io/r/stats/expand.model.frame.html" class="external-link">expand.model.frame()</a></code> should be <code>by[desvars]</code>,
and those names should be switched out of column names inthe data frame
<code><a href="https://rdrr.io/r/stats/expand.model.frame.html" class="external-link">expand.model.frame()</a></code> returns in favor of
<code>desvars</code>.</p>
<p>In order for <code>vcov.teeMod(m)</code> to work, the following
functions must have methods applicable to
<code>m@fitted_covariance_model</code>: <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>,
<code><a href="https://sandwich.R-Forge.R-project.org/reference/estfun.html" class="external-link">sandwich::estfun()</a></code>, <code><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">sandwich::bread()</a></code>. These
are similar requirements to those of
<code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="basis-in-known-extensions-of-huber-white-setup-to-chained-estimators">Basis in known extensions of Huber-White setup to chained
estimators<a class="anchor" aria-label="anchor" href="#basis-in-known-extensions-of-huber-white-setup-to-chained-estimators"></a>
</h2>
<p>With reference to the formulas for stacked estimating equations of
Carroll, Ruppert, Stefanski and Crainiceanu (2006, p.373), the
covariance model has psi functions (estimating equations)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\phi(\tilde{\mathbf{Y}},
\alpha)</annotation></semantics></math> with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>,
and Fisher information and estimating-equation covariance matrices
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>11</mn></msub><annotation encoding="application/x-tex">A_{11}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>
respectively; while the direct adjustment model’s are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mo>,</mo><mi>τ</mi><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\psi(\tilde{\mathbf{Y}}, \tau, \alpha)</annotation></semantics></math>,
the <code>treat</code> coefficients being
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
with sandwich components
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>22</mn></msub><annotation encoding="application/x-tex">A_{22}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>.
(The symbols
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\phi()</annotation></semantics></math>”,
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\psi()</annotation></semantics></math>”
and
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>”
are used as Carroll et al use them, while our
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>”
corresponds to their
script-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">{B}</annotation></semantics></math>.)</p>
<p>We take
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to range over the units of assignment (clusters) not elements<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We’ll need to aggregate (by summing) the elementwise
estimating equation contributions to the cluster level, to form
cluster-wise estimating equation contributions.&lt;/p&gt;"><sup>2</sup></a>. The
Carroll et al development is missing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>n</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">n^{-1}</annotation></semantics></math>
factors at the right of the equations defining
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi>n</mi><mo>,</mo><mspace width="0.167em"></mspace><mn>11</mn></mrow></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>B</mi><mrow><mi>n</mi><mo>,</mo><mspace width="0.167em"></mspace><mn>22</mn></mrow></msub></mrow><annotation encoding="application/x-tex">A_{n,\, 11}, \ldots, B_{n,\, 22}</annotation></semantics></math>.
To avoid ambiguities in mapping to external subroutines’ understanding
of
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>”<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Carroll et al seem to have a single sample in mind,
without clusters, whereas we have both
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;{C}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
and
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;{Q}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;,
with or without clusters. Where necessary, we use
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;msub&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;/msub&gt;&lt;annotation encoding="application/x-tex"&gt;n_{C}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
and
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;msub&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;/msub&gt;&lt;annotation encoding="application/x-tex"&gt;n_{Q}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
for the unit-of-assignment counts in the two samples respectively.&lt;/p&gt;'><sup>3</sup></a>, let’s
address the error by leaving those displays as-is, while striking the
leading
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>n</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">n^{-1}</annotation></semantics></math>
factors from display (A.34) and from the subsequent expression for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">v</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>B</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathrm{var}(\hat{{B}})</annotation></semantics></math>:
i.e., turn the A and B matrices into sums not means. Carroll et al’s
formulas for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>11</mn></msub><annotation encoding="application/x-tex">A_{11}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>21</mn></msub><annotation encoding="application/x-tex">A_{21}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>22</mn></msub><annotation encoding="application/x-tex">A_{22}</annotation></semantics></math>
then apply, although design-based standard errors call for different
calculations of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>12</mn></msub><annotation encoding="application/x-tex">B_{12}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>.
(When we get around to putting the multidecker sandwich together, we’ll
need to be cognizant of the fact that its As and Bs are means not sums,
and ready to compensate for the fact that it will have divided by
different
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">ns</annotation></semantics></math>
in figuring the means that are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>11</mn></msub><annotation encoding="application/x-tex">A_{11}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>22</mn></msub><annotation encoding="application/x-tex">A_{22}</annotation></semantics></math>,
for example.) Denote the clusters/units of assignment that are
represented in covariance and quasiexperimental samples by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">{C}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">{Q}</annotation></semantics></math>
respectively.</p>
</div>
<div class="section level2">
<h2 id="required-materials-for-se-calculations">Required materials for SE calculations<a class="anchor" aria-label="anchor" href="#required-materials-for-se-calculations"></a>
</h2>
<p>To estimate variances and covariances of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
we’ll need to assemble the following materials.</p>
<ol style="list-style-type: decimal">
<li>Sufficient information about
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">{C}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">{Q}</annotation></semantics></math>
to identify their intersection
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>∩</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">{C}\cap{Q}</annotation></semantics></math>,
as is needed to estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>;</li>
<li>Matrices of estimating functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo><mi>i</mi><mo>∈</mo><mi>C</mi><mo>∩</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\phi(\tilde{\mathbf{Y}}_i; \hat{\alpha}): i \in {C}\cap{Q}\}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo><mi>i</mi><mo>∈</mo><mi>C</mi><mo>∩</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, \hat{\alpha}): i \in {C}\cap{Q}\}</annotation></semantics></math>,
as are needed for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>;</li>
<li>For the quasiexperimental sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">{Q}</annotation></semantics></math>,
matrices
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>∇</mi><mi>α</mi></msub><mo stretchy="false" form="prefix">{</mo><munder><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>i</mi></mrow></munder><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>j</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo><mi>i</mi><mo>∈</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo><msub><mo stretchy="false" form="postfix">|</mo><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">\nabla_{\alpha} \{\sum_{j \in i}\psi(\tilde{\mathbf{Y}}_j, \hat{\tau}, {\alpha}):
i \in {Q}\} \vert_{\alpha=\hat\alpha},</annotation></semantics></math>
corresponding to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mn>21</mn></msub><annotation encoding="application/x-tex">A_{21}</annotation></semantics></math>,
where
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>∈</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">j \in i</annotation></semantics></math>”
means “elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
of cluster
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>”
and
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>i</mi></mrow></msub><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>j</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_{j \in i} \psi(\tilde{\mathbf{Y}}_j, \hat{\tau}, {\alpha})</annotation></semantics></math>”
is interpreted to mean
“<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, {\alpha})</annotation></semantics></math>”
if there is no clustering;</li>
<li>Estimates of the direct adjustment model’s “bread matrix”
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>n</mi><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>A</mi><mn>22</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><mo stretchy="false" form="prefix">{</mo><mfrac><mn>1</mn><mrow><mi>#</mi><mi>Q</mi></mrow></mfrac><msub><mi>∇</mi><mi>τ</mi></msub><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>Q</mi></mrow></msub><mi>𝔼</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mi>τ</mi><mo>,</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><msub><mo stretchy="false" form="postfix">|</mo><mrow><mi>τ</mi><mo>=</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover></mrow></msub><msup><mo stretchy="false" form="postfix">}</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">(n_{Q}^{-1} A_{22})^{-1} =
\{\frac{1}{\# {Q}}\nabla_\tau \sum_{i \in {Q}}
\mathbb{E}[\psi(\tilde{\mathbf{Y}}_i, \tau, \hat{\alpha})]
\vert_{\tau=\hat\tau}\}^{-1}</annotation></semantics></math>, i.e. the
inverse of its Fisher information w.r.t.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
only, along with the “meat matrix”
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>n</mi><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>B</mi><mn>22</mn></msub><mo>=</mo><msubsup><mi>n</mi><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><msub><mrow><mo stretchy="true" form="prefix">[</mo><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>Q</mi></mrow></msub><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mi>τ</mi><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub></mrow><annotation encoding="application/x-tex">n_{Q}^{-1} B_{22} = n_{Q}^{-1}
\mathrm{Cov}[\sum_{i \in {Q}} \psi(\tilde{\mathbf{Y}}_i,
{\tau}, {\alpha})]_{({\tau}, {\alpha})=(\hat{\tau}, \hat{\alpha})}</annotation></semantics></math>;</li>
<li>The covariance model’s bread matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mover><mi>A</mi><mo accent="true">̂</mo></mover><mn>11</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><mo stretchy="false" form="prefix">{</mo><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>C</mi></mrow></msub><msub><mi>∇</mi><mi>α</mi></msub><msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub><msup><mo stretchy="false" form="postfix">}</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">(n_{C}^{-1} \hat{A}_{11})^{-1} =
\{n_{C}^{-1}\sum_{i \in {C}}
\nabla_\alpha [\phi(\tilde{\mathbf{Y}}_i;
{\alpha})]_{\alpha=\hat\alpha}\}^{-1}</annotation></semantics></math>;
and</li>
<li>for covariance estimation in the conventional “model-based” setup
only, estimates of the covariance model’s B matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>B</mi><mn>11</mn></msub><mo>=</mo><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><msub><mrow><mo stretchy="true" form="prefix">[</mo><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>C</mi></mrow></msub><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub></mrow><annotation encoding="application/x-tex">n_{C}^{-1}B_{11} =
n_{C}^{-1}
\mathrm{Cov}[\sum_{i \in {C}}\phi(\tilde{\mathbf{Y}}_i;
{\alpha})]_{\alpha=\hat\alpha}</annotation></semantics></math> (a
“clustered” covariance estimate).</li>
</ol>
<p>In (5), observed information
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>C</mi></mrow></msub><msub><mi>∇</mi><mi>α</mi></msub><msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub></mrow><annotation encoding="application/x-tex">n_{C}^{-1}\sum_{i \in {C}}
\nabla_\alpha [\phi(\tilde{\mathbf{Y}}_i;
{\alpha})]_{\alpha=\hat\alpha}</annotation></semantics></math> is
preferred to “observed expected” information,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>n</mi><mi>C</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>C</mi></mrow></msub><msub><mi>∇</mi><mi>α</mi></msub><mi>𝔼</mi><msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub></mrow><annotation encoding="application/x-tex">n_{C}^{-1}\sum_{i \in {C}} \nabla_\alpha \mathbb{E}
[\phi(\tilde{\mathbf{Y}}_i; {\alpha})]_{\alpha=\hat\alpha}</annotation></semantics></math>,
because observed information is agnostic as to whether expectation is
calculated with conditioning on potential outcomes, ie the finite
population perspective, or with conditioning on treatment assignment,
the model based perspective. In the special case of quantile
regression<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Strictly speaking, the estimating equations of a
quantile regression aren’t differentiable in
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;α&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;\alpha&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;.
All directional derivatives will exist, and I’m expecting this to be
enough for our purposes, but I haven’t thought it through.&lt;/p&gt;'><sup>4</sup></a>, observed information isn’t ordinarily used
in standard error calculations, and it may take some doing to get.</p>
<p>Regarding (6),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>
is not needed for design-based standard errors, as in this setting
observations outside of the quasiexperimental sample do not contribute
to the covariance model’s B matrix. Only quasiexperimental sample
observations do, and we’ll have access to these when the direct
adjustment model is fit. As we also have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>;</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo><mi>i</mi><mo>∈</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\phi(\tilde{\mathbf{Y}}_i; \hat{\alpha}): i \in {Q}\}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo><mi>i</mi><mo>∈</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, \hat{\alpha}): i \in
{Q}\}</annotation></semantics></math>, we can use these materials to
estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>12</mn></msub><annotation encoding="application/x-tex">B_{12}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="software-implementation-comments-on-16-above-including-contents-of-sandwichveganlayerlayerkit-objects">Software implementation comments on 1–6 above, including contents of
{<code>Sandwich</code>/<code>Vegan</code>}{<code>Layer</code>/<code>LayerKit</code>}
objects<a class="anchor" aria-label="anchor" href="#software-implementation-comments-on-16-above-including-contents-of-sandwichveganlayerlayerkit-objects"></a>
</h2>
<p>1. A <code>SandwichLayer</code> object <code>s_l_o</code> carries a
<code>keys</code> data frame with which to identify rows of
<code>model.matrix(s_l_o)</code> with units of assignment (as named in a
separate Design object). The association can be many-one (but not
one-many); it is not required that named units appear in the design. As
<code>covmod</code> itself won’t be aware of these cluster associations,
assembling this info at runtime calls for trickery, as well as a means
for users to override the trickery and directly provide key variables
that the design will need. A falsy value in the <code>in_Q</code> column
of <code>keys</code> indicates an observation not appearing in the
<code>Design</code> object.</p>
<p>2. Estimating functions may need to be aggregated (summed) to the
cluster level before calculation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>.
There should be a dedicated function to calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>
from the cluster-aggregated estimating function matrices.</p>
<p>3. <code>PreSandwichLayer</code> and <code>SandwichLayer</code> have
an <code>@prediction_gradient</code> slot for a numeric matrix. This
matrix has as many rows as there are entries in the <code>.Data</code>
vector, and as many columns as there are estimating equations.</p>
<p>The <code>@prediction_gradient</code> slot carries
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>∇</mi><mi>α</mi></msub><msub><mi>f</mi><mi>α</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msub><mo stretchy="false" form="prefix">|</mo><mi>α</mi></msub><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\nabla_\alpha f_{\alpha}(\tilde{\mathbf{Y}}_j)|_\alpha=\hat\alpha\}</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
ranges over rows of <code>Q</code> as above – elements not clusters
where the distinction exists – and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>α</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐘</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_\alpha(\mathbf{Y})</annotation></semantics></math>
represents the prediction for data
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐘</mi><annotation encoding="application/x-tex">\mathbf{Y}</annotation></semantics></math>
from a fitted model of <code>class(cov_mod)</code> with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.
For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\psi()</annotation></semantics></math>’s
that use only “predictions” of the covariance model, as ours does, the
first derivative of the covariance model predictions as applied to data
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">{Q}</annotation></semantics></math>
will provide sufficient information from the covariance model to
complete the calculation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>∇</mi><mi>α</mi></msub><mi>ψ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐘</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><mo>,</mo><mover><mi>τ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mo stretchy="false" form="postfix">|</mo><mrow><mi>α</mi><mo>=</mo><mover><mi>α</mi><mo accent="true">̂</mo></mover></mrow></msub><mo>:</mo><mi>i</mi><mo>∈</mo><mi>Q</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\nabla_{\alpha}  \psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, {\alpha}) \vert_{\alpha=\hat\alpha}: i \in {Q}\}</annotation></semantics></math>.</p>
<p>For <code>glm</code> and similarly typed objects <code>cmod</code>,
such predictions are a joint function of <code>family(cmod)</code> and
the <code>model.matrix</code> generated in the process of creating
predictions from <code>cmod</code>.</p>
<p>4. The <code>SandwichLayer</code> class isn’t implicated in (4). We
can take extant calculations of a direct adjustment model’s information
matrix, with the proviso that we keep track of whatever scaling those
calculations may have applied. For design-based SEs we’ll need our own B
matrix calculation. For model-based SEs we can plug in to extant
routines for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>
also, but being careful ensure clustering on the units of assignment (as
named in a Design object). Scaling of these matrices should default to
the conventions of the sandwich package. (I haven’t considered whether
use of HC0–3 etc for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>
calls for corresponding adjustment to estimation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>
and/or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>,
nor whether heuristics animating these adjustments make sense in this
context.)</p>
<p>5. <code><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">sandwich::bread()</a></code> will be used to retrieve
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>A</mi><mn>11</mn><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><annotation encoding="application/x-tex">A_{11}^{-1}</annotation></semantics></math>.</p>
<p>We can take extant calculations of a covariance model’s information
matrix, defaulting to scaling conventions implemented in the sandwich
package.</p>
<p>6. <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">sandwich::meatCL()</a></code> will be used to retrieve
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>.
For now we only try to implement HC0 &amp; HC1. (I haven’t considered
whether use of HC0–3 etc for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>11</mn></msub><annotation encoding="application/x-tex">B_{11}</annotation></semantics></math>
calls for corresponding adjustment to estimation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>21</mn></msub><annotation encoding="application/x-tex">B_{21}</annotation></semantics></math>
and/or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mn>22</mn></msub><annotation encoding="application/x-tex">B_{22}</annotation></semantics></math>,
nor whether heuristics animating these adjustments make sense in this
context.)</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Josh Errickson, Josh Wasserman, Ben Hansen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
