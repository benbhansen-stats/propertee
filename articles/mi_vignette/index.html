<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>OLS effect and error estimation with an auxiliary sample and a separate, not-necessarily-linear covariance model • propertee</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="OLS effect and error estimation with an auxiliary sample and a separate, not-necessarily-linear covariance model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">propertee</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Basic</h6></li>
    <li><a class="dropdown-item" href="../../articles/intro-to-propertee.html">Introduction to propertee</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../../articles/non-binary-treatment.html">Non-binary Treatment Specification</a></li>
    <li><a class="dropdown-item" href="../../articles/RDD.html">Regression Discontinuity Designs</a></li>
    <li><a class="dropdown-item" href="../../articles/geex_vs_propertee.html">propertee vs. geex</a></li>
    <li><a class="dropdown-item" href="../../articles/mi_vignette/index.html">Real-data demonstration with a finely stratified cluster RCT and a broader administrative database</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/benbhansen-stats/propertee/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>OLS effect and error estimation with an auxiliary sample and a separate, not-necessarily-linear covariance model</h1>
            <h3 data-toc-skip class="subtitle">Real-data demonstration
with a finely stratified cluster RCT and a broader administrative
database</h3>
                        <h4 data-toc-skip class="author">Josh Wasserman,
Ben B. Hansen</h4>
            
            <h4 data-toc-skip class="date">2025-06-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/benbhansen-stats/propertee/blob/main/vignettes/mi_vignette/index.Rmd" class="external-link"><code>vignettes/mi_vignette/index.Rmd</code></a></small>
      <div class="d-none name"><code>index.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>propertee</code> package offers tools for enhancing
evaluations of treatments, policies, and interventions that respect the
statistical properties endowed by the study specification. One such
offering is a routine for covariance adjustment that allows researchers
to model exogenous variation in outcomes of interest using data from
their study as well as available auxiliary data. <code>propertee</code>
accommodates linear, generalized linear, and robust regression models,
providing users flexibility in functional form, fitting procedure, and
fitting sample. This vignette serves as a step-by-step walkthrough of
how users can use a prior covariance adjustment model fit to inform
estimates of intervention effects–as well as associated standard
errors–with the software in <code>propertee</code>.</p>
<p>Pane et al. (2014) mounted a large-scale cluster randomized trial in
seven states to study the effectiveness of Cognitive Tutor, an
online/in-person blended algebra learning program. Their report assessed
program effectiveness in terms of scores on a test administered as part
of the study. However, scores on prior and subsequent state achievement
tests are available for study schools as well as others in their states
and districts, and these could be used for a complementary, perhaps more
precise, assessment of the program’s effects. Here we demonstrate this
idea using state and district data from Michigan, where the Cognitive
Tutor study had a significant footprint and where rich school
achievement data are available for download from state websites.</p>
<p>Pane and coauthors kindly shared with us the names, pre-randomization
pairings and treatment assignments of their study’s 14 Michigan schools,
but were not at liberty to make this information public. To create a
functionally similar case study while maintaining the participating
schools’s anonymity, we optimally pair-matched them to schools from a
large nearby county in Michigan, Oakland. The pseudo-RCT considered in
this vignette replaces each Michigan Cognitive Tutor study school with
the Oakland County school it was paired to, otherwise inheriting from
the actual RCT salient specification characteristics, such as the
composition of school pairs and triples within which randomization was
conducted.</p>
<p>Valid analysis of an RCT calls for careful attention to such
characteristics, both for selecting a compatible estimator and for
correctly implementing it. By introducing a dedicated S4 structure for
such characteristics, the <code>StudySpecification</code>, along with
StudySpecification-aware functions for such tasks as inverse probability
weighting and effect estimation with optional stratum fixed effects,
<code>propertee</code> helps the analyst stay on top of implementation
details. Its <code><a href="../../reference/cov_adj.html">cov_adj()</a></code>, a specialized
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, decouples effect estimation from covariance
adjustment while continuing to track what’s necessary for valid standard
error estimation, significantly broadening the range of estimators that
are compatible with a given <code>StudySpecification</code>.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>To run this vignette, first download the necessary data. We will use
school-level averages of student performance on the Michigan Merit
Examination (MME) in 2014 to measure intervention effects, and we will
use school-level averages of scores on the 2012 and 2013 tests as
covariates in our covariance adjustment model. These scores can be
downloaded as a zipped file from the <a href="https://mischooldata.org/historical-assessment-data-files/" class="external-link">Michigan
Department of Education website</a>. After unzipping that file, convert
the resulting .xls file to a .csv to facilitate the use of base R
commands for loading it into an R session.</p>
<p>We also use school-level characteristics from the <a href="https://nces.ed.gov/ccd/files.asp#Fiscal:2,LevelId:7,SchoolYearId:28,Page:1" class="external-link">Common
Core of Data</a> in the covariance adjustment model. Click on the link
provided here, and download the “Flat File” for the 2013-2014 Public
Elementary/Secondary School Universe Survey under “Data File”. We can
use base R commands to load in the unzipped .txt file.</p>
<p>The last necessary file can be be loaded from the
<code>propertee</code> package by calling
<code>data(michigan_school_pairs)</code>. This dataframe tracks which
schools were paired together in the study and which schools were
assigned to intervention and control.</p>
</div>
<div class="section level2">
<h2 id="package-installation">Package Installation<a class="anchor" aria-label="anchor" href="#package-installation"></a>
</h2>
<p>This vignette requires the installation of three package in addition
to <code>propertee</code>: <code>httr</code> and <code>readxl</code>,
which we’ll use to import the Michigan schools data; and
<code>robustbase</code>, providing functionality for outlier-robust
regression. The vignette uses <code>robustbase</code> to demonstrate how
<code>propertee</code> can handle alternatives to ordinary least squares
for covariance adjustment modeling.</p>
</div>
<div class="section level2">
<h2 id="walkthrough">Walkthrough<a class="anchor" aria-label="anchor" href="#walkthrough"></a>
</h2>
<p>After loading the installed packages and reading in the downloaded
data files, we clean the MME scores and school characteristics datasets.
The scores data has rows corresponding to state-, intermediate school
district (ISD)-, district-, and campus-wide averages. In addition to
averages taken over all students in these subpopulations, some rows
correspond to averages taken within substrata formed by gender,
race/ethnicity, learning ability, or economic background. In the
provided cleaning script (<code>get_and_clean_external_data.R</code>),
we create two cleaned datasets, one for an analysis of the marginal
effect of the intervention and one for an analysis of the heterogeneity
of the intervention effect. Both datasets keep only rows corresponding
to schools where MME scores were reported campus-wide or for the
particular substratum in each of 2012, 2013, and 2014.</p>
<p>The school characteristics data spans the universe of public schools
in the United States, so to clean it for this vignette, we first limit
it to schools relevant to the study. The MME is taken almost exclusively
by 11th graders and, as the name suggests, only taken by students in
Michigan, so we first subset the data to schools in Michigan serving
11th graders. Then, we perform feature generation, creating derived
covariates such as demographic breakdowns by gender, race/ethnicity, and
free- or reduced-price lunch eligibility at the school level and in the
11th grade specifically. (The provided cleaning script performs these
steps also.)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://robustbase.R-forge.R-project.org/" class="external-link">"robustbase"</a></span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://robustbase.R-forge.R-project.org/" class="external-link">robustbase</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://readxl.tidyverse.org" class="external-link">"readxl"</a></span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org" class="external-link">readxl</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://httr.r-lib.org/" class="external-link">"httr"</a></span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/" class="external-link">httr</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/benbhansen-stats/propertee" class="external-link">"propertee"</a></span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/benbhansen-stats/propertee" class="external-link">propertee</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">extdataURLs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>CCD<span class="op">=</span><span class="st">"https://nces.ed.gov/ccd/data/zip/sc132a_txt.zip"</span>,</span>
<span>MME<span class="op">=</span><span class="st">"https://www.michigan.gov/cepi/-/media/Project/Websites/cepi/MiSchoolData/historical/Historical_Assessments/2011-2014MME.zip"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">michigan_school_pairs</span><span class="op">)</span></span>
<span><span class="va">michigan_school_pairs</span> <span class="op">&lt;-</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">michigan_school_pairs</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">blk</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">schoolid</span>,<span class="va">blk</span>,<span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"get_and_clean_external_data.R"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="creating-the-studyspecification-object">Creating the <code>StudySpecification</code> Object<a class="anchor" aria-label="anchor" href="#creating-the-studyspecification-object"></a>
</h4>
<p>The first step in estimating intervention effects using
<code>propertee</code> is to create a <code>StudySpecification</code>
object. This will store the information from
<code>michigan_school_pairs</code> in a way that will allow for quick
calculation of inverse probability of assignment weights that attend to
the pair-matched structure of the study.</p>
<p>In studies where units of observation (eg. individual students)
within units of assignment (eg. schools or districts) are used to
estimate intervention effects, the data structure should reflect this
nesting. For example, if we had student-level scores data as the
observed data within schools or districts, it is important to specify
how these units of assignment are allocated to different treatment or
control conditions. In such studies, the <code>StudySpecification</code>
object would also facilitate the definition of a vector of assignment
indicators at the unit of observation level we could use for estimating
the intervention effect.</p>
<p>Should more than one variable be needed to identify the unit of
assignment, block, or forcing, they can be included. For example,
perhaps <code>schoolidk</code> may be unique within district, but
potentially not unique across districts. Then we’d use something like
<code>block(districtid, schoolidk)</code> in the <code>_spec</code>
function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/StudySpecification_objects.html">rct_spec</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="fu"><a href="../../reference/StudySpecificationSpecials.html">unitid</a></span><span class="op">(</span><span class="va">schoolid</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../../reference/StudySpecificationSpecials.html">block</a></span><span class="op">(</span><span class="va">blk</span><span class="op">)</span>, <span class="va">michigan_school_pairs</span><span class="op">)</span></span></code></pre></div>
<p>In this <code><a href="../../reference/StudySpecification_objects.html">rct_spec()</a></code> call, the lefthand side indicates the
assignment variable, and the righthand side indicates the unit of
assignment and, if applicable, variable that identify matched sets or
strata. There are also <code><a href="../../reference/StudySpecification_objects.html">rd_spec()</a></code> and
<code><a href="../../reference/StudySpecification_objects.html">obs_spec()</a></code> constructors, for regression discontinuity and
for observational studies/quasiexperimental specifications,
respectively.</p>
<p>The <code>StudySpecification</code> object’s <code>structure</code>
slot lists units of assignment, their allocations to conditions and, if
applicable, blocks within which they were allocated.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span><span class="op">@</span><span class="va">structure</span></span></code></pre></div>
<pre><code><span><span class="co">##    z   schoolid blk</span></span>
<span><span class="co">## 1  1 6307005976   A</span></span>
<span><span class="co">## 2  0 6315004226   A</span></span>
<span><span class="co">## 3  1 6316006171   B</span></span>
<span><span class="co">## 4  0 6329004340   B</span></span>
<span><span class="co">## 5  1 6314002317   C</span></span>
<span><span class="co">## 6  0 6324009415   C</span></span>
<span><span class="co">## 7  1 6318000385   D</span></span>
<span><span class="co">## 8  0 6320001204   D</span></span>
<span><span class="co">## 9  0 6301004608   E</span></span>
<span><span class="co">## 10 0 6305000291   E</span></span>
<span><span class="co">## 11 1 6328002123   E</span></span>
<span><span class="co">## 12 1 6326003242   F</span></span>
<span><span class="co">## 13 0 6326005819   F</span></span>
<span><span class="co">## 14 1 6327000710   F</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="fitting-the-covariance-adjustment-model">Fitting the Covariance Adjustment Model<a class="anchor" aria-label="anchor" href="#fitting-the-covariance-adjustment-model"></a>
</h4>
<p>We now fit the covariance adjustment model. The
<code>propertee</code> package will generate predictions from this
regression to explain residual variation of the outcomes in the study.
Often, this produces more accurate and precise effect estimates. As
mentioned earlier, <code>propertee</code> accommodates a host of fitting
procedures for estimating this model, and the regression may leverage
data from available auxiliary sources. We demonstrate this flexibility
by fitting two covariance adjustment models for each analysis, one with
least squares and one with robust regression. We fit these models to a
sample including all schools in the study and all schools in Oakland
County whose outcomes and covariates are measured in the data we’ve
downloaded. The exact specification for this school-level model is
provided in Equation 1.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mtext mathvariant="normal">Average_Score_14</mtext></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mtext mathvariant="normal">Total_Enrollment_14</mtext><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mtext mathvariant="normal">Title_I_Status_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><mtext mathvariant="normal">Magnet_Status_14</mtext><mo>+</mo><msub><mi>β</mi><mn>4</mn></msub><mtext mathvariant="normal">Charter_Status_14</mtext><mo>+</mo><msub><mi>β</mi><mn>5</mn></msub><mtext mathvariant="normal">Education_Type_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>6</mn></msub><mtext mathvariant="normal">Perc_Female_14</mtext><mo>+</mo><msub><mi>β</mi><mn>7</mn></msub><mtext mathvariant="normal">Perc_Native_14</mtext><mo>+</mo><msub><mi>β</mi><mn>8</mn></msub><mtext mathvariant="normal">Perc_Asian_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>9</mn></msub><mtext mathvariant="normal">Perc_Hispanic_14</mtext><mo>+</mo><msub><mi>β</mi><mn>10</mn></msub><mtext mathvariant="normal">Perc_Black_14</mtext><mo>+</mo><msub><mi>β</mi><mn>11</mn></msub><mtext mathvariant="normal">Perc_White_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>12</mn></msub><mtext mathvariant="normal">Perc_Pacific_Islander_14</mtext><mo>+</mo><msub><mi>β</mi><mn>13</mn></msub><mtext mathvariant="normal">Perc_Econ_Disadvantaged_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>14</mn></msub><mtext mathvariant="normal">Perc_Female_Grade11_14</mtext><mo>+</mo><msub><mi>β</mi><mn>15</mn></msub><mtext mathvariant="normal">Perc_Native_Grade11_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>16</mn></msub><mtext mathvariant="normal">Perc_Asian_Grade11_14</mtext><mo>+</mo><msub><mi>β</mi><mn>17</mn></msub><mtext mathvariant="normal">Perc_Hispanic_Grade11_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>18</mn></msub><mtext mathvariant="normal">Perc_Black_Grade11_14</mtext><mo>+</mo><msub><mi>β</mi><mn>19</mn></msub><mtext mathvariant="normal">Perc_White_Grade11_14</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>20</mn></msub><mtext mathvariant="normal">Perc_Pacific_Islander_Grade11_14</mtext><mo>+</mo><msub><mi>β</mi><mn>21</mn></msub><mtext mathvariant="normal">Average_Score_13</mtext></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>22</mn></msub><mtext mathvariant="normal">Average_Score_12</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\text{Average_Score_14} &amp;= \beta_{0} + \beta_{1}\text{Total_Enrollment_14} + \beta_{2}\text{Title_I_Status_14}
\\&amp;\quad+
\beta_{3}\text{Magnet_Status_14} + \beta_{4}\text{Charter_Status_14} + \beta_{5}\text{Education_Type_14} \\&amp;\quad +
\beta_{6}\text{Perc_Female_14} + \beta_{7}\text{Perc_Native_14} + \beta_{8}\text{Perc_Asian_14} \\&amp;\quad +
\beta_{9}\text{Perc_Hispanic_14} + \beta_{10}\text{Perc_Black_14} + \beta_{11}\text{Perc_White_14} \\&amp;\quad+
\beta_{12}\text{Perc_Pacific_Islander_14} + \beta_{13}\text{Perc_Econ_Disadvantaged_14} \\&amp;\quad+
\beta_{14}\text{Perc_Female_Grade11_14} + \beta_{15}\text{Perc_Native_Grade11_14} \tag{1} \\ &amp;\quad+
\beta_{16}\text{Perc_Asian_Grade11_14} + \beta_{17}\text{Perc_Hispanic_Grade11_14} \\ &amp;\quad+
\beta_{18}\text{Perc_Black_Grade11_14} + \beta_{19}\text{Perc_White_Grade11_14} \\ &amp;\quad+
\beta_{20}\text{Perc_Pacific_Islander_Grade11_14} + \beta_{21}\text{Average_Score_13} \\&amp;\quad+
\beta_{22}\text{Average_Score_12}
\end{align}
</annotation></semantics></math></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coname</span> <span class="op">&lt;-</span> <span class="st">"OAKLAND COUNTY"</span></span>
<span><span class="va">RESPONSE_COL</span> <span class="op">&lt;-</span> <span class="st">"Average.Scale.Score.2014"</span></span>
<span><span class="va">MODELING_COLS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"TOTAL_ENROLLMENT"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">CCD_CAT_COLS</span>, <span class="st">"TYPE"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">analysis1data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"_PERC$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">analysis1data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MALE_PERC"</span>, <span class="st">"TR_PERC"</span>, <span class="st">"MALE_G11_PERC"</span>, <span class="st">"TR_G11_PERC"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Average.Scale.Score."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2013</span>, <span class="fl">2012</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_missing_resp</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">analysis1data</span><span class="op">[[</span><span class="va">RESPONSE_COL</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">not_missing_covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">analysis1data</span><span class="op">[</span>, <span class="va">MODELING_COLS</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="va">county_ix</span> <span class="op">&lt;-</span> <span class="va">analysis1data</span><span class="op">$</span><span class="va">CONAME</span> <span class="op">==</span> <span class="va">coname</span></span>
<span><span class="va">county_camod_dat</span> <span class="op">&lt;-</span> <span class="va">analysis1data</span><span class="op">[</span><span class="va">not_missing_resp</span> <span class="op">&amp;</span> <span class="va">not_missing_covs</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">camod_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">RESPONSE_COL</span>, <span class="st">"~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">MODELING_COLS</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_county_camod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">camod_form</span>, <span class="va">county_camod_dat</span>,</span>
<span>                      weights <span class="op">=</span> <span class="va">county_camod_dat</span><span class="op">$</span><span class="va">Total.Tested.2014</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">650</span><span class="op">)</span></span>
<span><span class="va">rob_county_camod</span> <span class="op">&lt;-</span> <span class="fu">robustbase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robustbase/man/lmrob.html" class="external-link">lmrob</a></span><span class="op">(</span></span>
<span>  <span class="va">camod_form</span>, <span class="va">county_camod_dat</span>, weights <span class="op">=</span> <span class="va">county_camod_dat</span><span class="op">$</span><span class="va">Total.Tested.2014</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">robustbase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robustbase/man/lmrob.control.html" class="external-link">lmrob.control</a></span><span class="op">(</span>max.it <span class="op">=</span> <span class="fl">500L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="estimating-marginal-intervention-effects">Estimating Marginal Intervention Effects<a class="anchor" aria-label="anchor" href="#estimating-marginal-intervention-effects"></a>
</h4>
<p>With the <code>StudySpecification</code> object created and the
covariance adjustment model fit, we’re prepared to evaluate the
intervention. <code>propertee</code> supports the calculations of
inverse probability of assignment weights, which can be used to estimate
either the average intervention effect (ATE) or the average effect for
the treated (ETT). These weights can be combined with additional unit
weights to reflect varying sizes of units in the sample. In this
analysis and the one that follows, we estimate the student-level ATE by
calculating inverse probability of assignment weights for each school
using the <code><a href="../../reference/WeightCreators.html">ate()</a></code> function, then multiplying those weights by
the number of students at the corresponding school who took the test. We
incorporate the prognostic model using the <code><a href="../../reference/cov_adj.html">cov_adj()</a></code>
function, which generates model predictions for each school and
identifies overlap between the prognostic sample and the study
sample.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">study1data</span> <span class="op">&lt;-</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">michigan_school_pairs</span>, <span class="va">analysis1data</span>, by <span class="op">=</span> <span class="st">"schoolid"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ip_wts</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">spec</span>, data <span class="op">=</span> <span class="va">study1data</span><span class="op">)</span> <span class="op">*</span> <span class="va">study1data</span><span class="op">$</span><span class="va">Total.Tested.2014</span></span>
<span><span class="va">lm_ca</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">lm_county_camod</span>, newdata <span class="op">=</span> <span class="va">study1data</span>, specification <span class="op">=</span> <span class="va">spec</span><span class="op">)</span></span></code></pre></div>
<p>Next, we estimate the intervention effect by using the
<code><a href="../../reference/lmitt.html">lmitt()</a></code> function. The only major difference between
<code><a href="../../reference/lmitt.html">lmitt()</a></code> and the base <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> function in the
requirement to specify a <code>StudySpecification</code> object. In this
<code><a href="../../reference/lmitt.html">lmitt()</a></code> function, we pass the inverse probability of
assignment weights to the <code>weights</code> argument and the adjusted
predictions to the <code>offset</code> argument.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">main_effect_fmla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">RESPONSE_COL</span>, <span class="st">"~1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_ca_effect</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/lmitt.html">lmitt</a></span><span class="op">(</span></span>
<span>  <span class="va">main_effect_fmla</span>, specification <span class="op">=</span> <span class="va">spec</span>, data <span class="op">=</span> <span class="va">study1data</span>, weights <span class="op">=</span> <span class="va">ip_wts</span>,</span>
<span>  offset <span class="op">=</span> <span class="va">lm_ca</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The summary of a fitted <code><a href="../../reference/lmitt.html">lmitt()</a></code> model, which is called a
<code>teeMod</code>, shows the estimated intervention effect and the
estimated standard error that has propagated uncertainty from the
covariance adjustment regression.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lm_ca_effect</span>, vcov.type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lmitt.formula(main_effect_fmla, specification = spec, data = study1data, weights = ip_wts, offset = lm_ca)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Treatment Effects :</span></span>
<span><span class="co">##                                       Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## z.                                      0.4732     1.0903   0.434    0.671    </span></span>
<span><span class="co">## Average.Scale.Score.2014:(Intercept) 1116.2153     3.9336 283.764   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## Std. Error calculated via type "HC0"</span></span></code></pre>
<p>Since no actual intervention was implemented in the pseudo-RCT, the
result of no effect is as expected.</p>
<p>To explore different variance estimation techniques, we can specify a
different <code>vcov.type</code> in the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lm_ca_effect</span>, vcov.type <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lmitt.formula(main_effect_fmla, specification = spec, data = study1data, weights = ip_wts, offset = lm_ca)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Treatment Effects :</span></span>
<span><span class="co">##                                       Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## z.                                      0.4732     1.1143   0.425    0.678    </span></span>
<span><span class="co">## Average.Scale.Score.2014:(Intercept) 1116.2153     3.9336 283.764   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## Std. Error calculated via type "HC1"</span></span></code></pre>
<p>If parts of the auxiliary sample (here, Oakland County other than the
14 study schools) follow a different pattern of association between
covariates and response, the covariance adjustment might wind up doing
more harm than good. To increase robustness to such contamination, we
can use robust linear regression for generating predictions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rob_ca</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">rob_county_camod</span>, newdata <span class="op">=</span> <span class="va">study1data</span>, specification <span class="op">=</span> <span class="va">spec</span><span class="op">)</span></span>
<span><span class="va">rob_ca_effect</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/lmitt.html">lmitt</a></span><span class="op">(</span></span>
<span>  <span class="va">main_effect_fmla</span>, specification <span class="op">=</span> <span class="va">spec</span>, data <span class="op">=</span> <span class="va">study1data</span>, weights <span class="op">=</span> <span class="va">ip_wts</span>,</span>
<span>  offset <span class="op">=</span> <span class="va">rob_ca</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rob_ca_effect</span>, vcov.type <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lmitt.formula(main_effect_fmla, specification = spec, data = study1data, weights = ip_wts, offset = rob_ca)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Treatment Effects :</span></span>
<span><span class="co">##                                       Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## z.                                      0.4446     1.1304   0.393      0.7    </span></span>
<span><span class="co">## Average.Scale.Score.2014:(Intercept) 1116.2153     3.9336 283.764   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## Std. Error calculated via type "HC1"</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="estimating-heterogeneous-intervention-effects">Estimating Heterogeneous Intervention Effects<a class="anchor" aria-label="anchor" href="#estimating-heterogeneous-intervention-effects"></a>
</h4>
<p>We can estimate average intervention effects conditional on different
race/ethinicity groups by using the second cleaned dataset.
<code>propertee</code> allows us to interpret the heterogenous effect
estimates as the average effect of the intervention on the average MME
score for students within each race/ethnicity group. The process for
estimating these heterogeneous effects follows a similar user experience
to the estimation of the marginal effect, but with two notable
exceptions.</p>
<div class="section level5">
<h5 id="exception-1-formula-specification">Exception 1: Formula Specification<a class="anchor" aria-label="anchor" href="#exception-1-formula-specification"></a>
</h5>
<p>The first exception is general to heterogeneous effect estimation
with the <code>propertee</code> package. When estimating these effects,
users need to modify the formula passed to <code><a href="../../reference/lmitt.html">lmitt()</a></code>. Instead
of specifying a constant (i.e. 1) on the right-hand side, users should
provide a formula that specifies the subgroup variable on the right-hand
side.</p>
<p>The first part of the code prepares the data by filtering out any
rows with missing values in the response variable or the covariates. We
also isolate data for the Oakland County.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_missing_resp</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">analysis2data</span><span class="op">[[</span><span class="va">RESPONSE_COL</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">not_missing_covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">analysis2data</span><span class="op">[</span>, <span class="va">MODELING_COLS</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="va">county_ix</span> <span class="op">&lt;-</span> <span class="va">analysis2data</span><span class="op">$</span><span class="va">CONAME</span> <span class="op">==</span> <span class="va">coname</span></span>
<span><span class="va">county_mod_camod_dat</span> <span class="op">&lt;-</span> <span class="va">analysis2data</span><span class="op">[</span><span class="va">not_missing_resp</span> <span class="op">&amp;</span> <span class="va">not_missing_covs</span>,<span class="op">]</span></span></code></pre></div>
<p>Next, we update the model formula to include the subgroup variable
<code>DemographicGroup</code>, which will be used to estimate
heterogeneous effects. We then use this updated formula to fit a
weighted linear regression model.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_camod_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">camod_form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">DemographicGroup</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_county_mod_camod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mod_camod_form</span>, <span class="va">county_mod_camod_dat</span>,</span>
<span>                          weights <span class="op">=</span> <span class="va">county_mod_camod_dat</span><span class="op">$</span><span class="va">Total.Tested.2014</span><span class="op">)</span></span></code></pre></div>
<p>Then, we prepare the study dataset by merging the cleaned dataset
with <code>michigan_school_pairs</code> to ensure we have school-level
data that allows for the estimation of treatment effects based on school
and demographic group.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">study2data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">michigan_school_pairs</span>, <span class="va">analysis2data</span>, by <span class="op">=</span> <span class="st">"schoolid"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">study2data</span> <span class="op">&lt;-</span> <span class="va">study2data</span><span class="op">[</span><span class="va">study2data</span><span class="op">$</span><span class="va">DemographicGroup</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"White"</span>, <span class="st">"Black or African American"</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>Now, we compute the inverse probability weights using the
<code><a href="../../reference/WeightCreators.html">ate()</a></code> function, which estimates the average effect
treatment. Then, we adjust for covariates using
<code><a href="../../reference/cov_adj.html">cov_adj()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ip_wts</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">spec</span>, data <span class="op">=</span> <span class="va">study2data</span><span class="op">)</span> <span class="op">*</span> <span class="va">study2data</span><span class="op">$</span><span class="va">Total.Tested.2014</span></span>
<span><span class="va">lm_mod_ca</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">lm_county_mod_camod</span>, newdata <span class="op">=</span> <span class="va">study2data</span>,</span>
<span>                                specification <span class="op">=</span> <span class="va">spec</span>, by <span class="op">=</span> <span class="st">"uniqueid"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we specify a formula for estimating heterogeneous effects
and fit the model using the <code><a href="../../reference/lmitt.html">lmitt()</a></code> function.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_effect_fmla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">RESPONSE_COL</span>, <span class="st">"~ DemographicGroup"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_ca_mod_effect</span> <span class="op">&lt;-</span> <span class="fu">propertee</span><span class="fu">::</span><span class="fu"><a href="../../reference/lmitt.html">lmitt</a></span><span class="op">(</span><span class="va">mod_effect_fmla</span>, specification <span class="op">=</span> <span class="va">spec</span>,</span>
<span>                                     data <span class="op">=</span> <span class="va">study2data</span>, weights <span class="op">=</span> <span class="va">ip_wts</span>,</span>
<span>                                     offset <span class="op">=</span> <span class="va">lm_mod_ca</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lm_ca_mod_effect</span>, vcov.type <span class="op">=</span> <span class="st">"CR1"</span>, cluster <span class="op">=</span> <span class="st">"schoolid"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lmitt.formula(mod_effect_fmla, specification = spec, data = study2data, weights = ip_wts, offset = lm_mod_ca)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Treatment Effects :</span></span>
<span><span class="co">##                                                                    Estimate</span></span>
<span><span class="co">## `z._DemographicGroupBlack or African American`                        0.326</span></span>
<span><span class="co">## z._DemographicGroupWhite                                              1.337</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupBlack or African American 1090.477</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupWhite                     1115.743</span></span>
<span><span class="co">##                                                                    Std. Error</span></span>
<span><span class="co">## `z._DemographicGroupBlack or African American`                          1.990</span></span>
<span><span class="co">## z._DemographicGroupWhite                                                1.290</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupBlack or African American      2.347</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupWhite                          2.716</span></span>
<span><span class="co">##                                                                    t value</span></span>
<span><span class="co">## `z._DemographicGroupBlack or African American`                       0.164</span></span>
<span><span class="co">## z._DemographicGroupWhite                                             1.036</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupBlack or African American 464.646</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupWhite                     410.767</span></span>
<span><span class="co">##                                                                    Pr(&gt;|t|)    </span></span>
<span><span class="co">## `z._DemographicGroupBlack or African American`                        0.876    </span></span>
<span><span class="co">## z._DemographicGroupWhite                                              0.347    </span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupBlack or African American 8.76e-13 ***</span></span>
<span><span class="co">## Average.Scale.Score.2014:DemographicGroupWhite                     1.62e-12 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## Std. Error calculated via type "CR1"</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="second-exception-overlapping-rows">Second Exception: Overlapping Rows<a class="anchor" aria-label="anchor" href="#second-exception-overlapping-rows"></a>
</h5>
<p>The second exception arises when units of assignment (in this case,
schools) contribute multiple observations to the heterogeneous effect
estimation. This can happen because schools may have students in
multiple race/ethnicity groups, leading to overlap in the data.The
<code>StudySpecification</code> object does not provide enough
information to uniquely identify these rows, which causes an issue for
standard error calculations that must determine the exact overlap
between the covariance adjustment and effect estimation samples. To
alleviate this issue, both dataframes must have a column that uniquely
identifies each row. If the two dataframes have overlapping rows, these
unique identifiers should match up.</p>
</div>
</div>
<div class="section level4">
<h4 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h4>
<p>This vignette has demonstrated how to use the <code>propertee</code>
package to enhance the evaluation of treatment effects by incorporating
covariance adjustment models. The following key concepts and commands
were covered:</p>
<ul>
<li>Create a <code>StudySpecification</code> object which encodes the
design, including the unit of assignment, treatment status of each unit
of assignment, and optionally block information. This is done using the
<code><a href="../../reference/StudySpecification_objects.html">rct_spec()</a></code> or optionally <code><a href="../../reference/StudySpecification_objects.html">obs_spec()</a></code> and
<code><a href="../../reference/StudySpecification_objects.html">rd_spec()</a></code> functions.</li>
<li>Fit both least squares and robust regression models to adjust for
covariates and enhance the precision of treatment effect estimates.</li>
<li>Use the <code><a href="../../reference/cov_adj.html">cov_adj()</a></code> function to process the covariate
adjustment model.</li>
<li>Fit a model using the <code><a href="../../reference/lmitt.html">lmitt()</a></code> function to estimate
treatment effect that accounts for the specification information and the
covariate adjustment by including the <code>weights</code> and
<code>offset</code> arguments in the function.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Josh Errickson, Josh Wasserman, Ben Hansen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
