# propertee: **P**rognostic **R**egression **O**ffsets with **P**ropagation of **ER**rors, for **T**reatment **E**ffect **E**stimation

**propertee** enables flexible direct adjustment with
specification-informed standard errors and optional prior covariance
adjustment.

Random trials often utilize units of assignment and blocking in
assigning treatment status as a way to simplify implementation. Standard
errors and other inferential calculations should respect such aspects of
the study’s design. Using **propertee**, a user can generate a
“StudySpecification” object which will keep track of the design
specification.

``` R
spec <- rct_spec(txt ~ unit_of_assignment(teacher) + block(school), data = teacherdata)
```

(Also supported are observational studies
([`obs_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md))
and regression discontinuity specifications (`rdd_spec()` which requires
a
[`forcing()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
variable as well.)

In order to pass the design specification into the model using the
`weights=` argument, functions
[`ett()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
and
[`ate()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
will be used to convert the StudySpecification into a numeric vector
with the StudySpecification object as an attribute.

``` R
lm(y ~ txt, data = studentdata, weights = ate(spec))
```

Note that this StudySpecification is created with teacher level data
(`teacherdata`), but the analysis is carried out at the student level
(`studentdata`); the
[`ate()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
(and its alternatives
[`att()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md),
[`atc()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
and
[`ato()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md))
will expand the weights appropriately.

Optionally, we can also include a covariance adjustment model through
the
[`cov_adj()`](https://benbhansen-stats.github.io/propertee/dev/reference/cov_adj.md)
function.

``` R
covadjmod <- lm(y ~ x1 + x2 + ..., data = studentdata, subset = !txt)
lm(y ~ txt, studentdata, weights = ett(spec),
   offset = cov_adj(covadjmod, data = studentdata)
)
```

The effect estimation model is expected to be an lm object, but the
covariance model can be of type `glm` or `lmrob`, among others: with a
binary outcome, for example, it might be a logistic regression.

Having fit covariance and effect estimation models separately, you may
need standard errors that propagate variation from the former to the
latter. propertee’s “lmitt” objects are lm’s enhanced with information
from the StudySpecification and covariance adjustment model that
standard error calculations may need. Fitted lm’s of the accommodated
type may be coerced to lmitt using
[`as.lmitt()`](https://benbhansen-stats.github.io/propertee/dev/reference/as_lmitt.md);
or you can skip this step by using
[`propertee::lmitt()`](https://benbhansen-stats.github.io/propertee/dev/reference/lmitt.md)
to fit the lm in the first place:

``` R
lmitt(y ~ 1, studentdata, specificaton = spec, weights = "ett",
      offset = cov_adj(covadjmod, data = studentdata)
  )
```

For more, see the package’s vignettes.

## Contributing

You may use RStudio to develop for **propertee**, by opening the
`propertee.Rproj` file. We suggest you ensure all required dependencies
are installed by running

``` R
devtools::install_deps(dependencies = TRUE)
```

We prefer changes that include unit tests demonstrating the problem or
showing how the new feature should be added. The test suite uses the
[testthat](https://github.com/hadley/test_that) package to write and run
tests. (Please ensure you have the latest version of testthat (or at
least v0.11.0), as older versions stored the tests in a different
directory, and may not test properly.) See the `tests/testthat`
directory for examples. You can run the test suite via Build -\> Test
Package.

New features should include inline [Roxygen](http://roxygen.org/)
documentation. You can generate all `.Rd` documents from the `Roxygen`
code using Build -\> Document, or using Make as describe below.

Finally, you can use Build -\> Build and Reload or Build -\> Clean and
Rebuild to load an updated version of **propertee** in your current
RStudio session. Alternatively, to install the developed version
permanently, use Build -\> Build Binary Version, followed by

``` R
install.packages("../propertee_VERSION.tgz", repo=NULL)
```

You can revert back to the current CRAN version by

``` R
remove.packages("propertee")
install.packages("propertee")
```

If you prefer not to use RStudio, you can develop using Make.

- `make test`: Run the full test suite.
- `make document`: Update all documentation from Roxygen inline
  comments.
- `make interactive`: Start up an interactive session with **propertee**
  loaded. (`make interactive-emacs` starts the session inside emacs.)
- `make check`: Run `R CMD check` on the package
- `make build`: Build a binary package.
- `make vignette`: Builds any vignettes in `vignettes/` directory
- `make clean`: Removes files built by `make vignette`, `make document`
  or `make check`. Should not be generally necessary, but can be useful
  for debugging.

When your change is ready, make a pull request on github.

### White space changes

To ease searches of the commit history:

- Commit white space changes only when they occur on lines with
  substantive changes.
- Avoid committing trailing white spaces.

In **RStudio**, there are options to enable automatically removing white
space as the end of lines and trailing whitespaces in the Settings, Code
-\> Saving.

In **emacs**, you can remove white spaces at ends of lines with
`M-x delete-trailing-whitespace`. To do this automatically whenever you
save, add the following to your init file:

``` R
(add-hook 'before-save-hook (lambda ()
                             (delete-trailing-whitespace)))
```

To remove trailing lines when saving, you can also add this:

``` R
(setq delete-trailing-lines t)
```

### Referring to functions

When documentation refers to another function (internal to the package
or otherwise), please include the trailing `()`, as that will help
**pkgdown** provide an appropriate link (see
<https://pkgdown.r-lib.org/articles/linking.html>).

E.g. `\code{lm()}` or `\code{cov_adj()}` or `\code{lme4::lmer()}`.

### Vignettes or simulations

Vignettes and simulations should go in the
[/vignettes/](https://github.com/benbhansen-stats/propertee/tree/main/vignettes)
folder. Anything that should not be built by R check (especially
anything that builds very slowly, or introduces dependencies not
specified in
[DESCRIPTION](https://github.com/benbhansen-stats/propertee/blob/main/DESCRIPTION))
should go in the
[/vignettes/not-for-cran](https://github.com/benbhansen-stats/propertee/tree/main/vignettes/not-for-cran).
(The not-for-cran folder is in the
[.Rbuildignore](https://github.com/benbhansen-stats/propertee/blob/main/.Rbuildignore)
file.)

Note that ALL .Rmd files in /vignettes/ get built during building of the
reference site. To exclude a .Rmd file, it needs to start with “\_“.
E.g. `myslowvignette.Rmd` -\> `_myslowvignette.Rmd`.

# Package index

## StudySpecification

### Creation of `StudySpecification` Objects

- [`rct_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`rd_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`obs_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`rct_specification()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`rd_specification()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`obs_specification()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`obsstudy_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  [`obsstudy_specification()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_objects.md)
  :

  Generates a `StudySpecification` object with the given specifications.

- [`unit_of_assignment()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  [`unitid()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  [`cluster()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  [`uoa()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  [`block()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  [`forcing()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecificationSpecials.md)
  :

  Special terms in `StudySpecification` creation formula

- [`as_rct_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/specificationconversion.md)
  [`as_obs_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/specificationconversion.md)
  [`as_rd_spec()`](https://benbhansen-stats.github.io/propertee/dev/reference/specificationconversion.md)
  :

  Convert `StudySpecification` between types

### Accessors/Replacers for `StudySpecification` Objects

- [`treatment()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `treatment<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`units_of_assignment()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `units_of_assignment<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`clusters()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `clusters<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`unitids()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `unitids<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`blocks()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `blocks<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`has_blocks()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`forcings()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  [`` `forcings<-`() ``](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_extractreplace.md)
  :

  Accessors and Replacers for `StudySpecification` objects

- [`has_binary_treatment()`](https://benbhansen-stats.github.io/propertee/dev/reference/has_binary_treatment.md)
  :

  Check whether treatment stored in a `StudySpecification` object is
  binary

### Summary and print methods

- [`show(`*`<StudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/show-StudySpecification-method.md)
  :

  Show a `StudySpecification`

- [`summary(`*`<StudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_summary.md)
  [`print(`*`<summary.StudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_summary.md)
  :

  Summarizing `StudySpecification` objects

### Structure of `StudySpecification` objects

- [`get_structure()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_structure.md)
  [`show(`*`<StudySpecificationStructure>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_structure.md)
  :

  `StudySpecification` Structure Information

- [`specification_table()`](https://benbhansen-stats.github.io/propertee/dev/reference/specification_table.md)
  [`stable()`](https://benbhansen-stats.github.io/propertee/dev/reference/specification_table.md)
  :

  Table of elements from a `StudySpecification`

- [`var_table()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_var_names.md)
  [`var_names()`](https://benbhansen-stats.github.io/propertee/dev/reference/StudySpecification_var_names.md)
  :

  Extract Variable Names from `StudySpecification`

### Utility Functions for `StudySpecification` Objects

- [`identify_small_blocks()`](https://benbhansen-stats.github.io/propertee/dev/reference/identify_small_blocks.md)
  : Identify fine strata

- [`specification_data_concordance()`](https://benbhansen-stats.github.io/propertee/dev/reference/specification_data_concordance.md)
  : Check for variable agreement within units of assignment

- [`identical_StudySpecifications()`](https://benbhansen-stats.github.io/propertee/dev/reference/identical_StudySpecifications.md)
  :

  Test equality of two `StudySpecification` objects

## Weights

Functions to create or interact with Weights

- [`ett()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`att()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`ate()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`etc()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`atc()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`ato()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`olw()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`owt()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  [`pwt()`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightCreators.md)
  : Generate Direct Adjusted Weights for Treatment Effect Estimation

### Working with `WeightedStudySpecification` objects

- [`weights(`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/weights-WeightedStudySpecification-method.md)
  :

  Extract Weights from `WeightedStudySpecification`

- [`` `+`( ``*`<WeightedStudySpecification>`*`,`*`<numeric>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `+`( ``*`<numeric>`*`,`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `-`( ``*`<WeightedStudySpecification>`*`,`*`<numeric>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `-`( ``*`<numeric>`*`,`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `*`( ``*`<WeightedStudySpecification>`*`,`*`<numeric>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `*`( ``*`<numeric>`*`,`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `/`( ``*`<WeightedStudySpecification>`*`,`*`<numeric>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  [`` `/`( ``*`<numeric>`*`,`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecificationOps.md)
  :

  `WeightedStudySpecification` Operations

- [`c(`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/c-WeightedStudySpecification-method.md)
  : Concatenate weights

- [`subset(`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecification.subset.md)
  [`` `[`( ``*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/WeightedStudySpecification.subset.md)
  :

  `WeightedStudySpecification` subsetting

- [`show(`*`<WeightedStudySpecification>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/show-WeightedStudySpecification-method.md)
  :

  Show a `WeightedStudySpecification`

## Covariance Adjustment & SandwichLayer

- [`cov_adj()`](https://benbhansen-stats.github.io/propertee/dev/reference/cov_adj.md)
  :

  Covariance adjustment of `teeMod` model estimates

- [`as.SandwichLayer()`](https://benbhansen-stats.github.io/propertee/dev/reference/as.SandwichLayer.md)
  :

  Convert a `PreSandwichLayer` to a `SandwichLayer` with a
  `StudySpecification` object

- [`subset(`*`<PreSandwichLayer>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/PreSandwichLayer.subset.md)
  [`` `[`( ``*`<PreSandwichLayer>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/PreSandwichLayer.subset.md)
  :

  `PreSandwichLayer` and `SandwichLayer` subsetting

- [`show(`*`<PreSandwichLayer>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/PreSandwichLayer.show.md)
  :

  Show a `PreSandwichLayer` or `SandwichLayer`

- [`bread(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/bread.teeMod.md)
  :

  Extract bread matrix from a `teeMod` model fit

- [`estfun(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/estfun.teeMod.md)
  :

  Extract empirical estimating equations from a `teeMod` model fit

- [`estfun(`*`<lmrob>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/lmrob_methods.md)
  [`bread(`*`<lmrob>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/lmrob_methods.md)
  :

  Generate matrix of estimating equations for `lmrob()` fit

- [`estfun(`*`<glmrob>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/glmrob_methods.md)
  [`bread(`*`<glmrob>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/glmrob_methods.md)
  :

  Extract empirical estimating equations from a `glmbrob` model fit

## Estimating Model

Functions to carry out the treatment estimation accounting for the
StudySpecification

- [`lmitt()`](https://benbhansen-stats.github.io/propertee/dev/reference/lmitt.md)
  : Linear Model for Intention To Treat

- [`assigned()`](https://benbhansen-stats.github.io/propertee/dev/reference/AssignedAliases.md)
  [`adopters()`](https://benbhansen-stats.github.io/propertee/dev/reference/AssignedAliases.md)
  [`a.()`](https://benbhansen-stats.github.io/propertee/dev/reference/AssignedAliases.md)
  [`z.()`](https://benbhansen-stats.github.io/propertee/dev/reference/AssignedAliases.md)
  : Obtain Treatment from StudySpecification

- [`as.lmitt()`](https://benbhansen-stats.github.io/propertee/dev/reference/as_lmitt.md)
  [`as.teeMod()`](https://benbhansen-stats.github.io/propertee/dev/reference/as_lmitt.md)
  :

  Convert `lm` object into `teeMod`

- [`confint(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/confint.teeMod.md)
  :

  Confidence intervals with standard errors provided by
  [`vcov.teeMod()`](https://benbhansen-stats.github.io/propertee/dev/reference/vcov.teeMod.md)

- [`show(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/show-teeMod-method.md)
  :

  Show a `teeMod`

- [`summary(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/teeMod_summary.md)
  [`print(`*`<summary.teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/teeMod_summary.md)
  :

  Summarizing `teeMod` objects

- [`vcov(`*`<teeMod>`*`)`](https://benbhansen-stats.github.io/propertee/dev/reference/vcov.teeMod.md)
  :

  Compute variance-covariance matrix for fitted `teeMod` model

- [`vcov_tee()`](https://benbhansen-stats.github.io/propertee/dev/reference/var_estimators.md)
  [`.vcov_DB0()`](https://benbhansen-stats.github.io/propertee/dev/reference/var_estimators.md)
  [`.vcov_DB()`](https://benbhansen-stats.github.io/propertee/dev/reference/var_estimators.md)
  :

  Variance/Covariance for `teeMod` objects

## Data

- [`STARplus`](https://benbhansen-stats.github.io/propertee/dev/reference/STARplus.md)
  : STAR participants plus nonexperimental controls
- [`lsoSynth`](https://benbhansen-stats.github.io/propertee/dev/reference/lsoSynth.md)
  : Synthethic Regression Discontinuity Data
- [`schooldata`](https://benbhansen-stats.github.io/propertee/dev/reference/studentdata.md)
  [`studentdata`](https://benbhansen-stats.github.io/propertee/dev/reference/studentdata.md)
  : Student data
- [`simdata`](https://benbhansen-stats.github.io/propertee/dev/reference/simdata.md)
  : Simulated data
- [`michigan_school_pairs`](https://benbhansen-stats.github.io/propertee/dev/reference/michigan_school_pairs.md)
  : Intervention data from a pair-matched study of schools in Michigan
- [`GV_data`](https://benbhansen-stats.github.io/propertee/dev/reference/GV_data.md)
  : Cluster-randomized experiment data on voter turnout in cable system
  markets

# Articles

### All vignettes

- [propertee vs.
  geex](https://benbhansen-stats.github.io/propertee/dev/articles/geex_vs_propertee.md):
- [OLS effect and error estimation with an auxiliary sample and a
  separate, not-necessarily-linear covariance
  model](https://benbhansen-stats.github.io/propertee/dev/articles/mi_vignette/index.md):
- [Introduction to
  propertee](https://benbhansen-stats.github.io/propertee/dev/articles/intro-to-propertee.md):
- [Non-binary Treatment
  Specification](https://benbhansen-stats.github.io/propertee/dev/articles/non-binary-treatment.md):
- [Regression Discontinuity
  Design](https://benbhansen-stats.github.io/propertee/dev/articles/RDD.md):
