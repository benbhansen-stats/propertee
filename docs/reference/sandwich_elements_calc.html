<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="(Internal) Compute variance blocks"><title>(Internal) Compute variance blocks — .get_b12 • flexida</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="(Internal) Compute variance blocks — .get_b12"><meta property="og:description" content="(Internal) Compute variance blocks"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flexida</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/CovarianceAdjustment.html">Covariance Adjustment for Randomized Trials</a>
    <a class="dropdown-item" href="../articles/LinearModelVarianceEstimation.html">Variance Estimation Testing Using A Simple Linear Specification</a>
    <a class="dropdown-item" href="../articles/RDD.html">Regression Discontinuity Designs</a>
    <a class="dropdown-item" href="../articles/design_based_SEs.html">Design based sandwich SEs for differences of Hajek estimators</a>
    <a class="dropdown-item" href="../articles/not-for-cran/non-binary-weights.html">Non-Binary Treatment</a>
    <a class="dropdown-item" href="../articles/sandwich_infrastructure.html">Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/benbhansen-stats/flexida/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>(Internal) Compute variance blocks</h1>
      <small class="dont-index">Source: <a href="https://github.com/benbhansen-stats/flexida/blob/HEAD/R/SandwichLayerVariance.R" class="external-link"><code>R/SandwichLayerVariance.R</code></a></small>
      <div class="d-none name"><code>sandwich_elements_calc.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>(Internal) Compute variance blocks</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">.get_b12</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get_a22_inverse</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get_b22</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get_a11_inverse</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get_b11</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">.get_a21</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>x</dt>
<dd><p>A <code>DirectAdjusted</code> model</p></dd>


<dt>...</dt>
<dd><p>Arguments to be passed to sandwich::meatCL</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p><code>.get_b12()</code>: A \(p\times k\) matrix where \(p\) is the
number of terms in the covariance model and \(k\) is the number of terms
in the <code>DirectAdjusted</code> model</p>


<p><code>.get_a22_inverse()</code>: A \(1\times1\) matrix</p>


<p><code>.get_b22()</code>: A \((p+1)\times(p+1)\) matrix where the
dimensions are given by the number of terms in the <code>DirectAdjusted</code> model
(\(p\)) and an Intercept term. This should be a \(2\times2\) matrix
given the dichotomous handling of treatment variables in this package and
the use of the covariance model to offer the covariance adjustment.</p>


<p><code>.get_a11_inverse()</code>: A \((p+1)\times(p+1)\) matrix where the
dimensions are given by the number of terms in the covariance model
(\(p\)) and an Intercept term.</p>


<p><code>.get_b11()</code>: A \((p+1)\times(p+1)\) matrix the dimensions are
given by the number of terms in the covariance model (\(p\)) and an
Intercept term</p>


<p><code>.get_a12()</code>: A \((p+1)\times2\) matrix where the number of
rows are given by the number of terms in the covariance model (\(p\)) and
an Intercept term, and the number of columns are given by the treatment and
intercept terms in the direct adjustment model</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <b>B12 block</b> is the covariance matrix of the cluster-level
estimating equations for the covariance and direct adjustment models. It
has a row for each term in the covariance model and a column for each term
in the direct adjustment model. For any row that does not appear in both
the experimental design and the covariance model data, its contribution to
this matrix will be 0. Thus, if there is no overlap between the two
datasets, this will return a matrix of 0's.</p>
<p>The <b>A22 block</b> is the diagonal element of the inverse expected
Fisher Information matrix corresponding to the treatment estimate. As shown
in the Details of <code>.get_b22()</code>, the estimating equations for a
generalized linear model with a canonical link function can be written as
$$\psi_i = (r_i / Var(y_i)) * (d\mu_i/d\eta_i) * x_i$$ The expected
information matrix A22 is then the negative Jacobian of \(\psi_i\), which
by likelihood theory is the variance-covariance matrix of \(\psi_i\):
$$\psi_{i}\psi_{i}^{T} = E[(r_i / Var(y_i) * (d\mu_i/d\eta_i))^{2}] *
  x_ix_i' = (d\mu_i/d\eta_i)^{2} / Var(y_i) * x_ix_i'$$ Considering the whole
sample, this can be expressed in matrix form as \(X'WX\). The output of
this function is the inverse of the diagonal element corresponding to the
treatment estimate.</p>
<p>The <b>B22 block</b> refers to a clustered variance estimate of the
treatment effect estimate. The <code>stats</code> package offers family objects
with canonical link functions, so the log-likelihood for a generalized
linear model can be written in terms of the linear predictor as
$$L(y_i, \beta, \phi, w_i) = w_i * (y_i * \beta'x_i - b(\beta'x_i)) /
  \phi + h(y_i; \phi)$$ The estimating equations \(\psi_i\) given by the
score function can then be expressed as $$\psi_i = E[w_i * (y_i -
  \mu(\beta'x_i)) * x_i / \phi]$$ In section 4.4 of the second edition of
Categorical Data Analysis, Agresti shows the derivative of the mean
function with respect to the linear predictor is equivalent to the weighted
variance for an observation divided by the estimate of the dispersion
parameter. Thus, the above estimating equations can also be written as
$$\psi_i = (r_i / Var(y_i)) * (d\mu_i/d\eta_i) * x_i$$</p>
<p>A matrix \(C\) of dimension \(n\times J\) is formed to indicate which
unit each subject in the design belongs to, where \(J\) is the number of
units at the level of treatment assignment. The treatment assignment-level
estimating equations are then obtained via \(C'\psi\), where \(\psi\)
is the matrix of estimating equations at the subject level.</p>
<p>The <b>A11 block</b> is the \(p\times p\) matrix corresponding to
the unscaled inverse of the observed Fisher information of the covariance
model. The observed information is given by the estimate of the negative
Jacobian of the model's estimating equations. The unscaled version provided
here divides by the number of observations used to fit the covariance
model.</p>
<p>The <b>B11 block</b> is the block of the sandwich variance estimator
corresponding to the variance-covariance matrix of the covariance model
coefficient estimates. The estimates returned here are potentially
clustered (by the clustering in the experimental design) if rows in the
covariance model data also exist in the design. If there is no overlap
between the two datasets, the variance-covariance matrix is estimated
assuming the observations are independent.</p>
<p>The <b>A21 block</b> is the block of the sandwich variance estimator
corresponding to the gradient of the direct adjustment model with respect
to the covariates. Some of the information needed for this calculation is
stored in the <code>DirectAdjusted</code> object's <code>SandwichLayer</code> offset. This
block is the crossproduct of the prediction gradient and the gradient of
the conditional mean vector for the direct adjustment model summed to the
cluster level. In other words, we take this matrix to be $$\sum(d\psi_i
  / d\alpha) = -\sum(w_i/\phi) * (d\mu(\eta_i) / d\eta_i) *
  (d\upsilon(\zeta_i) / d\zeta_i) * (x_i c_i)x_i'$$ where \(\mu\) and
\(\eta_i\) are the conditional mean function and linear predictor for the
ith cluster in the direct adjustment model, and \(\upsilon\) and
\(\zeta_i\) are the conditional mean function and linear predictor for
the ith cluster in the covariance model.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Agresti, Alan. Categorical Data Analysis. 2003. Open WorldCat,
https://nbn-resolving.org/urn:nbn:de:101:1-201502241089.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer></div>

  

  

  </body></html>

