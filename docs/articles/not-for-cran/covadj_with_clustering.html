<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="flexida">
<title>Covariance-adjusted standard errors in a clustered longitudinal setting • flexida</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Covariance-adjusted standard errors in a clustered longitudinal setting">
<meta property="og:description" content="flexida">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">flexida</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/CovarianceAdjustment.html">Covariance Adjustment for Randomized Trials</a>
    <a class="dropdown-item" href="../../articles/LinearModelVarianceEstimation.html">Variance Estimation Testing Using A Simple Linear Specification</a>
    <a class="dropdown-item" href="../../articles/RDD.html">Regression Discontinuity Designs</a>
    <a class="dropdown-item" href="../../articles/design_based_SEs.html">Design based sandwich SEs for differences of Hajek estimators</a>
    <a class="dropdown-item" href="../../articles/not-for-cran/covadj_with_clustering.html">Covariance-adjusted standard errors in a clustered longitudinal setting</a>
    <a class="dropdown-item" href="../../articles/not-for-cran/non-binary-weights.html">Non-Binary Treatment</a>
    <a class="dropdown-item" href="../../articles/not-for-cran/polynomialSimulation.html">Polynomial Simulation like in LRD paper</a>
    <a class="dropdown-item" href="../../articles/sandwich_infrastructure.html">Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/benbhansen-stats/flexida/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Covariance-adjusted standard errors in a clustered longitudinal setting</h1>
                        <h4 data-toc-skip class="author">Josh Wasserman</h4>
            
            <h4 data-toc-skip class="date">July 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/benbhansen-stats/flexida/blob/HEAD/vignettes/not-for-cran/covadj_with_clustering.Rmd" class="external-link"><code>vignettes/not-for-cran/covadj_with_clustering.Rmd</code></a></small>
      <div class="d-none name"><code>covadj_with_clustering.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="covariance-adjusted-sandwich-variance-estimator-with-varying-samples-for-the-covariance-and-direct-adjustment-models">Covariance-Adjusted Sandwich Variance Estimator with Varying Samples for the Covariance and Direct Adjustment Models<a class="anchor" aria-label="anchor" href="#covariance-adjusted-sandwich-variance-estimator-with-varying-samples-for-the-covariance-and-direct-adjustment-models"></a>
</h2>
<p>We extend the work of Carroll et al. and Stefanski and Boos to derive the covariance-adjusted sandwich variance estimator when two potentially different samples are used to fit the covariance and direct adjustment models. We pay additional attention here to the setting with clustered longitudinal data.</p>
<p>To refresh the reader of (or introduce them to) the authors’ notation, <span class="math inline">\(\theta = \begin{pmatrix}\beta\ &amp; \tau\end{pmatrix}\)</span> is a parameter vector where <span class="math inline">\(\beta\)</span> is a <span class="math inline">\(p\text{x}1\)</span> vector of nuisance parameters associated with factors <span class="math inline">\(\textbf{x}\)</span> known or suspected to co-vary with the potential outcomes, and <span class="math inline">\(\tau\)</span> is a <span class="math inline">\(2\text{x}1\)</span> vector of an intercept term for the direct adjustment model and the intent-to-treat effect. The covariance model regression solves the set of estimating equations of the form specified by <span class="math inline">\(\phi\)</span> for <span class="math inline">\(\beta\)</span>, and the direct adjustment regression solves another set of estimating equations given by <span class="math inline">\(\psi\)</span> for <span class="math inline">\(\tau\)</span>. These regressions can be considered as a set of stacked M-estimating equations <span class="math inline">\(G(\theta)\)</span>, following the notation of Stefanski and Boos.</p>
<p>The data in this clustered longitudinal setting are triple indexed by unit, time period and cluster. Units are members of clusters, and at each of <span class="math inline">\(T\)</span> time periods, new clusters are introduced to the design, some of which may be exposed to the treatment. Clusters then may be viewed as treatment cohorts measured over <span class="math inline">\(T_{i}\)</span> time periods, with the first cohort measured for <span class="math inline">\(T_{1} - T_{n}\)</span> more time periods than the <span class="math inline">\(n\)</span>th cohort. Since treatment assignment is invariant over time, we need not worry about units appearing in both treatment groups and confounding fixed effects estimation of the intent-to-treat effect. It is important to note that clusters that do not participate in the quasiexperiment may still be used to fit the covariance model, so the number of clusters in that sample will be denoted <span class="math inline">\(n_{C}\)</span>, with each cluster consisting of <span class="math inline">\(m_{i}\)</span> units such that <span class="math inline">\(m_{C} = \sum_{i=1}^{n_{C}}T_{i}m_{i}\)</span>. The number of clusters in the quasiexperiment–and thus used to fit the direct adjustment model–will be denoted <span class="math inline">\(n_{Q}\)</span>, with each cluster consisting of <span class="math inline">\(m_{i}\)</span> units such that <span class="math inline">\(m_{Q} = \sum_{i=1}^{n_{Q}}T_{i}m_{i}\)</span>. To provide further notational clarity, we denote data points in the covariance model sample with an asterisk–this will be most beneficial in the derivation of the variance estimator when we will be dealing with the variance-covariance matrix of the two sets of estimating equations. Now, we define <span class="math inline">\(G(\theta)\)</span>:</p>
<p><span class="math display">\[
\begin{split}
G(\theta) &amp;= \begin{pmatrix}
m_{C}^{-1}\sum_{i=1}^{n_{C}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\phi(y_{ijt}^{*}; \textbf{x}_{ijt}^{*}, \beta) \\
m_{Q}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\psi(y_{ijt}; \textbf{x}_{ijt}, \textbf{z}_{ijt}, \beta, \tau)
\end{pmatrix}
\end{split}
\]</span></p>
<div class="section level3">
<h3 id="deriving-the-scaling-factors-for-the-components-of-the-variance-estimator">Deriving the Scaling Factors for the Components of the Variance Estimator<a class="anchor" aria-label="anchor" href="#deriving-the-scaling-factors-for-the-components-of-the-variance-estimator"></a>
</h3>
<p>Stefanski and Boos show the asymptotic variance of <span class="math inline">\(\hat{\theta}\)</span>, <span class="math inline">\(\text{Cov}(\hat{\theta})\)</span>, is <span class="math inline">\(n^{-1}A^{-1}BA^{-T}\)</span>, where <span class="math inline">\(A\)</span> is a 2x2 block matrix corresponding to the negative Fisher information for the estimating equations, and <span class="math inline">\(B\)</span> is their variance-covariance matrix. Carroll et al. derive this estimator in the covariance adjustment setting where a single sample is used to estimate <span class="math inline">\(\theta\)</span>. Since we derive the variance estimator for scenarios where this is not the case, we need to determine the scaling factors more carefully. In the following derivation, we will not specify regression forms for <span class="math inline">\(\phi(y_{ijt}^{*}; \textbf{x}_{ijt}^{*}, \beta)\)</span> and <span class="math inline">\(\psi(y_{ijt}; \textbf{x}_{ijt}, \textbf{z}_{ijt}, \beta, \tau)\)</span>, and for ease of notation, we will shorten them to <span class="math inline">\(\phi_{ijt}\)</span> and <span class="math inline">\(\psi_{ijt}\)</span>, respectively. Also, in addition to previous notation, let <span class="math inline">\(n_{QC}\)</span> be the number of clusters present in both the covariance model and direct adjustment model samples, with <span class="math inline">\(m_{QC} = \sum_{i=1}^{n_{QC}}T_{i}m_{i}\)</span>. The <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> matrices can then be written as: <span class="math display">\[
\begin{split}
A &amp;= -\frac{\partial}{\partial\theta}G(\theta) \\\\ &amp;=
-\begin{pmatrix}
{m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}] &amp;
0 \\
{m_{Q}}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\beta^{T}}] &amp;
{m_{Q}}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]
\end{pmatrix} \\\\
B &amp;=
\text{Cov}(G(\theta)) \\\\ &amp;=
\begin{pmatrix}
{m_{C}}^{-1}({m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}\phi_{ijt}\phi_{ijt}^{T}) &amp;
\frac{m_{QC}}{m_{C}m_{Q}}(m_{QC}^{-1}\sum_{i=1}^{n_{QC}}\sum_{j\in{m_{i}}, t\in{T_{i}}}\phi_{ijt}\psi_{ijt}^{T}) \\
\frac{m_{QC}}{m_{C}m_{Q}}(m_{QC}^{-1}\sum_{i=1}^{n_{QC}}\sum_{j\in{m_{i}}, t\in{T_{i}}}\psi_{ijt}\phi_{ijt}^{T}) &amp;
{m_{Q}}^{-1}(m_{Q}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}\psi_{ijt}\psi_{ijt}^{T})
\end{pmatrix}
\end{split}
\]</span></p>
<p>Using block matrix inversion, <span class="math inline">\(A^{-1}\)</span> and <span class="math inline">\(A^{-T}\)</span>, can be shown to be: <span class="math display">\[
\begin{split}
A^{-1} &amp;=
\begin{pmatrix}
-\big{(}{m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}]\big{)}^{-1} &amp; 0 \\
\big{(}{m_{Q}}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]\big{)}^{-1}
\big{(}{m_{Q}}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{jjt}}{\partial\beta^{T}}]\big{)}
\big{(}{m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}]\big{)}^{-1} &amp;
-\big{(}m_{Q}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]\big{)}^{-1}
\end{pmatrix} \\\\
A^{-T} &amp;=
\begin{pmatrix}
-\big{(}{m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}]\big{)}^{-1} &amp;
\big{(}{m_{C}}^{-1}\sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}]\big{)}^{-1}
\big{(}{m_{Q}}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\beta^{T}}]\big{)}^{T}
\big{(}m_{Q}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]\big{)}^{-1} \\
0 &amp;
-\big{(}m_{Q}^{-1}\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]\big{)}^{-1}
\end{pmatrix}
\end{split}
\]</span></p>
<p>As mentioned previously, Carroll et al. refer to the elements of the <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> matrices as sums. For example, their <span class="math inline">\(B_{11} = \sum_{i=1}^{n_{C}}\sum_{j\in{m_{i}}, t\in{T_{i}}}\phi_{ijt}\phi_{ijt}^{T}\)</span>, and their <span class="math inline">\(A_{22}^{-1} = (\sum_{i=1}^{n_{Q}}\sum_{j\in{m_{i}}, t\in{T_{i}}}E[\frac{\partial\psi_{ijt}}{\partial\theta^{T}}])^{-1}\)</span>. <code>flexida</code>’s suite of internal functions for computing these elements block matrices follow Carroll et al.’s definitions, so the scaling factors need to be properly accounted for in the complete calculation of <span class="math inline">\(\text{Cov}(\hat{\theta})\)</span>. We derive the covariance-adjusted sandwich variance estimate below using those matrix definitions and append the appropriate scaling factors. Since the variance of the intent-to-treat effect estimate <span class="math inline">\(\text{Cov}(\hat{\tau})\)</span> can be estimated by <span class="math inline">\(\text{Cov}(\hat{\theta})_{22}\)</span>, we replace elements of the intermediary matrices that are tangential to that calculation with dots: <span class="math display">\[
\begin{split}
\text{Cov}(\hat{\theta}) &amp;=
m_{Q}^{-1}\begin{pmatrix}
. &amp; . \\
m_{C}^{-1}A_{22}^{-1}A_{21}A_{11}^{-1}B_{11} - m_{C}^{-1}A_{22}^{-1}B_{21} &amp;
m_{Q}^{-1}A_{22}^{-1}A_{21}A_{11}^{-1}B_{12} - m_{Q}^{-1}A_{22}^{-1}B_{22}
\end{pmatrix}
\begin{pmatrix}
. &amp; m_{C}A_{11}^{-1}A_{21}^{T}A_{22}^{-1} \\ . &amp; -m_{Q}A_{22}^{-1}
\end{pmatrix} \\ &amp;=
m_{Q}^{-1}\begin{pmatrix}
. &amp; . \\ . &amp;
A_{22}^{-1}A_{21}A_{11}^{-1}B_{11}A_{11}^{-1}A_{21}^{T}A_{22}^{-1} - 
A_{22}^{-1}B_{21}A_{11}^{-1}A_{21}^{T}A_{22}^{-1} -
A_{22}^{-1}A_{21}A_{11}^{-1}B_{12}A_{22}^{-1} +
A_{22}^{-1}B_{22}A_{22}^{-1}
\end{pmatrix} \\\\
\text{Cov}(\hat{\tau}) &amp;=
m_{Q}^{-1}A_{22}^{-1}\Big{(}
B_{22} - 
B_{21}A_{11}^{-1}A_{21}^{T} -
A_{21}A_{11}^{-1}B_{12} +
A_{21}A_{11}^{-1}B_{11}A_{11}^{-1}A_{21}^{T}\Big{)}A_{22}^{-1}
\end{split}
\]</span></p>
</div>
<div class="section level3">
<h3 id="block-components-of-the-sandwich-variance-estimator">Block Components of the Sandwich Variance Estimator<a class="anchor" aria-label="anchor" href="#block-components-of-the-sandwich-variance-estimator"></a>
</h3>
<p>We now derive the blocks of the <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> matrices in the case where <span class="math inline">\(G(\theta)\)</span> is solved using two OLS regressions. The direct adjusted model will be fit using weights appropriate for the intent-to-treat effect target, and though in practice the covariance model may be fit with weights, we complete the derivations without them because the decision to include such weights is immaterial to the primary estimation goal. <span class="math inline">\(\phi(y_{ijt}^{*}; \textbf{x}_{ijt}^{*}, \beta)\)</span> and <span class="math inline">\(\psi(y_{ijt}; \textbf{x}_{ijt}, \textbf{z}_{ijt}, \beta, \tau)\)</span> can be written as: <span class="math display">\[
\begin{split}
\phi(y_{ijt}^{*}; \textbf{x}_{ijt}^{*}, \beta) = \phi_{ijt} &amp;= (y_{ijt}^{*} - \beta^{T}\textbf{x}_{ijt}^{*})\textbf{x}_{ijt}^{*} \\
\psi(y_{ijt}; \textbf{x}_{ijt}, \textbf{z}_{ijt}, \beta, \tau) = \psi_{ijt} &amp;= w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}
\end{split}
\]</span></p>
<p>Matrices such as the full design matrices for the regressions given by <span class="math inline">\(\phi\)</span> and <span class="math inline">\(\psi\)</span> will be denoted using capital letters, while vectors will be denoted using bold font. We will have need to display cluster-level vectors and matrices that have been formed from the appropriate units. These will be indexed by a single letter <span class="math inline">\(i\)</span>; matrices including either the entire covariance model or direct adjustment model sample will have no subscript. With this notation, we derive each block of the <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> matrices: <span class="math display">\[
\begin{split}
A_{11}^{-1} &amp;=
-\Big{(}\sum_{i=1}^{n_{C}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial\phi_{ijt}}{\partial\beta^{T}}]\Big{)}^{-1} \\ &amp;=
-\Big{(}\sum_{i=1}^{n_{C}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial}{\partial\beta^{T}}(y_{ijt}^{*} - \beta^{T}\textbf{x}_{ijt}^{*})\textbf{x}_{ijt}^{*}]\Big{)}^{-1} \\ &amp;=
\Big{(}\sum_{i=1}^{n_{C}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\textbf{x}_{ijt}^{*}\textbf{x}_{ijt}^{*T}]\Big{)}^{-1} \\ &amp;=
(X^{*T}X^{*})^{-1} \\\\
A_{21} &amp;=
-\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial\psi_{ijt}}{\partial\beta^{T}}] \\ &amp;=
-\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial}{\partial\beta^{T}}w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}] \\ &amp;=
\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[w_{ijt}\textbf{z}_{ijt}\textbf{x}_{ijt}^{T}] \\ &amp;=
Z^{T}WX \\\\
A_{22}^{-1} &amp;=
-\Big{(}\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial\psi_{ijt}}{\partial\tau^{T}}]\Big{)}^{-1} \\ &amp;=
-\Big{(}\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[\frac{\partial}{\partial\tau^{T}}w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}]\Big{)}^{-1} \\ &amp;=
\Big{(}\sum_{i=1}^{n_{Q}}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}E[w_{ijt}\textbf{z}_{ijt}\textbf{z}_{ijt}^{T}]\Big{)}^{-1} \\ &amp;=
(Z^{T}WZ)^{-1} \\\\
B_{11} &amp;=
\sum_{i=1}^{n_{C}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\phi_{ijt}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T}\phi_{ijt}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{C}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}(y_{ijt}^{*} - \beta^{T}\textbf{x}_{ijt}^{*})\textbf{x}_{ijt}^{*}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}(y_{ijt}^{*} - \beta^{T}\textbf{x}_{ijt}^{*})\textbf{x}_{ijt}^{*}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{C}}X_{i}^{T}(\textbf{y}_{i} - X_{i}\beta)(\textbf{y}_{i} - X_{i}\beta)^{T}X_{i} \\\\
B_{12} &amp;=
\sum_{i=1}^{n_{QC}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\phi_{ijt}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\psi_{ijt}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{QC}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T}(y_{ijt} - \beta^{T}\textbf{x}_{ijt})\textbf{x}_{ijt}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{QC}}X_{i}^{T}(\textbf{y}_{i} - X_{i}\beta)(\textbf{w}_{i} \cdot (\textbf{y}_{i} - X_{i}\beta - Z_{i}\tau))^{T}Z_{i} \\\\
B_{22} &amp;=
\sum_{i=1}^{n_{Q}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\psi_{ijt}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}\psi_{ijt}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{Q}}\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}\Big{)}
\Big{(}\sum_{j=1}^{m_{i}}\sum_{t=1}^{T_{i}}w_{ijt}(y_{ijt} - \beta^{T}\textbf{x}_{ijt} - \tau^{T}\textbf{z}_{ijt})\textbf{z}_{ijt}\Big{)}^{T} \\ &amp;=
\sum_{i=1}^{n_{Q}}Z_{i}^{T}(\textbf{w}_{i} \cdot (\textbf{y}_{i} - X_{i}\beta - Z_{i}\tau))(\textbf{w}_{i} \cdot (\textbf{y}_{i} - X_{i}\beta - Z_{i}\tau))^{T}Z_{i}
\end{split}
\]</span></p>
</div>
<div class="section level3">
<h3 id="validating-the-flexida-variance-estimates">Validating the <code>flexida</code> Variance Estimates<a class="anchor" aria-label="anchor" href="#validating-the-flexida-variance-estimates"></a>
</h3>
<p>This section aims to validate <code>flexida</code>’s machinery for computing <span class="math inline">\(\text{Cov}(\hat{\tau})\)</span>.</p>
<div class="section level4">
<h4 id="data-simulation-and-model-fitting">Data Simulation and Model Fitting<a class="anchor" aria-label="anchor" href="#data-simulation-and-model-fitting"></a>
</h4>
<p>Suppose we have unit-level data for 4 evenly-sized clusters that comprise 2 identically matched pairs, one that is observed for 2 time periods and the other for only 1 time period:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">mi</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">TT</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="co"># matched pair 1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="st">"cid"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">mi</span> <span class="op">*</span> <span class="va">TT</span><span class="op">)</span>,</span>
<span>    <span class="st">"uid"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">mi</span><span class="op">)</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">TT</span><span class="op">)</span>,</span>
<span>    <span class="st">"z"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">mi</span> <span class="op">*</span> <span class="va">TT</span><span class="op">)</span>,</span>
<span>    <span class="st">"t"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">TT</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">mi</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"x1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>, <span class="va">nc</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">TT</span><span class="op">)</span>,</span>
<span>    <span class="st">"x2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>, <span class="va">nc</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">TT</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co"># matched pair 2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="st">"cid"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span>, each <span class="op">=</span> <span class="va">mi</span> <span class="op">*</span> <span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"uid"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">mi</span><span class="op">)</span>, <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"z"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">mi</span> <span class="op">*</span> <span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"t"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, each <span class="op">=</span> <span class="va">mi</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"x1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>, <span class="va">nc</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"x2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mi</span> <span class="op">*</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>, <span class="va">nc</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">TT</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x1_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            </span></span>
<span><span class="co">##             x1_0 x1_1</span></span>
<span><span class="co">##   cluster_1   32    8</span></span>
<span><span class="co">##   cluster_2   32    8</span></span>
<span><span class="co">##   cluster_3    8   12</span></span>
<span><span class="co">##   cluster_4    8   12</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x2_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            </span></span>
<span><span class="co">##             x2_0 x2_1</span></span>
<span><span class="co">##   cluster_1   20   20</span></span>
<span><span class="co">##   cluster_2   20   20</span></span>
<span><span class="co">##   cluster_3   12    8</span></span>
<span><span class="co">##   cluster_4   12    8</span></span></code></pre>
<p>We generate <span class="math inline">\(y\)</span> such that it does not depend on <span class="math inline">\(t\)</span>, but only depends on the covariates and the treatment assignment (which is orthogonal to the covariates). Thus, the error terms are uncorrelated within each unit, correlated but homoskedastic within each cluster and uncorrelated but heteroskedastic across cluster:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75</span>, <span class="fl">7.5</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="va">error_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">icc</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">eps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">msk</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">cid</span> <span class="op">==</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">Sigma</span><span class="op">[</span><span class="va">msk</span>, <span class="va">msk</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">error_sd</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">icc</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">msk</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">icc</span></span>
<span><span class="op">}</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="va">eps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">eps</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">z</span>, <span class="va">df</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">theta</span> <span class="op">+</span> <span class="va">eps</span></span></code></pre></div>
<p>One way we might consider implementing covariance adjustment is by fitting the covariance model only to the control observations of the quasiexperimental sample:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmod_form</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span></span>
<span><span class="va">damod_form</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="va">z</span></span>
<span><span class="va">ctrl_idx</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">z</span> <span class="op">==</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">cmod_form</span>, <span class="va">df</span><span class="op">[</span><span class="va">ctrl_idx</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/Design_objects.html">rct_design</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="fu"><a href="../../reference/DesignSpecials.html">cluster</a></span><span class="op">(</span><span class="va">cid</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">damod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/as_lmitt.html">as.lmitt</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">damod_form</span>, data <span class="op">=</span> <span class="va">df</span>, weights <span class="op">=</span> <span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fu"><a href="../../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="verifying-flexidas-block-matrix-outputs-with-expected-outputs">Verifying <code>flexida</code>’s Block Matrix Outputs with Expected Outputs<a class="anchor" aria-label="anchor" href="#verifying-flexidas-block-matrix-outputs-with-expected-outputs"></a>
</h4>
<p>We derived the forms of the covariance-adjusted sandwich variance estimate matrix components previously, so we verify the outputs of <code>flexida</code>’s internal functions match those:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xstar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">cmod_form</span>, <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span></span>
<span><span class="va">mQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">a11inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">Xstar</span>, <span class="va">Xstar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a21</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">a22inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span>, <span class="va">Z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">b11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">Xstar</span> <span class="op">*</span> <span class="va">cmod</span><span class="op">$</span><span class="va">residuals</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span>, <span class="va">colSums</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">b12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">Xstar</span> <span class="op">*</span> <span class="va">cmod</span><span class="op">$</span><span class="va">residuals</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span>, <span class="va">colSums</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">Z</span><span class="op">[</span><span class="va">ctrl_idx</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">residuals</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span>,</span>
<span>            <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span>,</span>
<span>            <span class="va">colSums</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">b22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span> <span class="op">*</span> <span class="va">damod</span><span class="op">$</span><span class="va">residuals</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span>, <span class="va">colSums</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"sandwich components match derivations"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">a11inv</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a11_inverse</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">a21</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a21</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">a22inv</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a22_inverse</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">b11</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b11</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">b12</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b12</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">b22</span>, <span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b22</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 😀</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="verifying-flexidas-block-matrix-outputs-to-the-sandwich-package">Verifying <code>flexida</code>’s Block Matrix Outputs to the <code>sandwich</code> Package<a class="anchor" aria-label="anchor" href="#verifying-flexidas-block-matrix-outputs-to-the-sandwich-package"></a>
</h4>
<p>We also verify our calculations with the <code>sandwich</code> package in the following three places:</p>
<ol style="list-style-type: decimal">
<li>
<code>sandwich::bread(damod)</code> returns <span class="math inline">\(m_{Q}\cdot(ZWZ)^{-1}\)</span>, so we confirm <span class="math inline">\(A_{22}^{-1}\)</span> is equivalent to <code>sandwich::bread(damod) / m_{Q}</code>.</li>
<li>
<code>.get_b22(damod, ...)</code> is a wrapper around <code>sandwich::meatCL(damod, ...)</code> but automatically generates the appropriate <code>cluster</code> argument based on the <code>Design</code> object. Thus, we somewhat trivially confirm <code>B_{22}</code> is equivalent to <code>sandwich::meatCL(damod, cluster = df$cid) * m_{Q}</code>.</li>
<li>We can test the above two points for the covariance model as well, using <code>sandwich::sandwich(cmod)</code> to validate <span class="math inline">\(A_{11}^{-1}B_{11}A_{11}^{-1}\)</span>.</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"compare with sandwich components"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">a22inv</span>, <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">bread</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span> <span class="op">/</span> <span class="va">mQ</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">b22</span>,</span>
<span>               <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span><span class="op">(</span><span class="va">damod</span>, cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>,</span>
<span>                                cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span> <span class="op">*</span> <span class="va">mQ</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b11</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span>,</span>
<span>               <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">cmod</span>,</span>
<span>                                  meat. <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span>,</span>
<span>                                  cluster <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">[</span><span class="va">ctrl_idx</span><span class="op">]</span>,</span>
<span>                                  cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 😸</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="verifying-flexidas-variance-estimate-to-geex">Verifying <code>flexida</code>’s Variance Estimate to <code>geex</code><a class="anchor" aria-label="anchor" href="#verifying-flexidas-variance-estimate-to-geex"></a>
</h4>
<p>The <code>geex</code> package, developed by <a href="https://bsaul.github.io/geex/" class="external-link">Bradley Saul</a>, provides an interface for numerically approximating M-estimates and their variance-covariance matrices. This offers an apples-to-apples comparison to <code>flexida</code>’s variance estimates; we just need to define the estimating functions for the given setting as the <code>geex</code> package requires. Since the intercept terms in the covariance and direct adjustment models have perfect collinearity (and moreover, at the time of this writing a desirable analytical method for handling this is not clear), we fit the covariance model with an intercept but exclude one from the direct adjustment model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estFunc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">cmod_form</span>, <span class="va">damod_form</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># covariance model eqns for ctrl obs only</span></span>
<span>    <span class="va">Xstar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">cmod_form</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Xstar</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">cmod_agg_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">p</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="va">colSums</span>, <span class="va">sum</span><span class="op">)</span></span>
<span>      <span class="va">cmod_eqns</span> <span class="op">&lt;-</span> <span class="fu">cmod_agg_func</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">-</span> <span class="va">Xstar</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">Xstar</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">cmod_eqns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># direct adjustment model eqns for full dataset</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">cmod_form</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">damod_form</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">damod_agg_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">q</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="va">colSums</span>, <span class="va">sum</span><span class="op">)</span></span>
<span>    <span class="va">damod_eqns</span> <span class="op">&lt;-</span> <span class="fu">damod_agg_func</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">weight</span> <span class="op">*</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">]</span> <span class="op">-</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="va">q</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">*</span> <span class="va">Z</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cmod_eqns</span>, <span class="va">damod_eqns</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span>  </span>
<span><span class="va">geex_cmod_form</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">geex_cmod_form</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">geex_damod_form</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">geex_damod_form</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">geexRes</span> <span class="op">&lt;-</span> <span class="fu">geex</span><span class="fu">::</span><span class="fu"><a href="https://bsaul.github.io/geex/reference/m_estimate.html" class="external-link">m_estimate</a></span><span class="op">(</span></span>
<span>  <span class="va">estFunc</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"weight"</span> <span class="op">=</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span>,</span>
<span>  units <span class="op">=</span> <span class="st">"cid"</span>,</span>
<span>  root_control <span class="op">=</span> <span class="fu">geex</span><span class="fu">::</span><span class="fu"><a href="https://bsaul.github.io/geex/reference/setup_root_control.html" class="external-link">setup_root_control</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="va">p</span> <span class="op">+</span> <span class="va">q</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  outer_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cmod_form <span class="op">=</span> <span class="va">geex_cmod_form</span>,</span>
<span>                    damod_form <span class="op">=</span> <span class="va">geex_damod_form</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"compare with geex"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, type <span class="op">=</span> <span class="st">"HC0"</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>               <span class="va">geexRes</span><span class="op">@</span><span class="va">vcov</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 🎉</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="heuristic-checks">Heuristic Checks<a class="anchor" aria-label="anchor" href="#heuristic-checks"></a>
</h4>
<p>We now make heuristic checks of <code>flexida</code>’s covariance-adjusted variance estimates. The covariance-adjusted estimate changes the sandwich variance estimate of the direct adjustment model parameters by three terms that include <span class="math inline">\(A_{22}^{-1}A_{21}\)</span>, which can be viewed as linear regression coefficients of the treatment assignment variable on the covariates in the direct adjustment sample. When the treatment assignment is perfectly balanced within each covariate, the covariance between the treatment variable and the covariates will be 0, resulting in zero regression adjustment to the variance estimate of the treatment effect estimate. Intuitively, the variance that may arise in the observed outcomes due to differences in the composition of the treatment and control groups is eliminated when the treatment is assigned in such a way that there <em>are</em> no compositional differences between the groups. Thus, in these scenarios, further covariance adjustment is unnecessary. The data we have simulated here represent one such scenario, since the clusters in the each matched pair are identical. As a result, <code>flexida</code>’s variance estimate for the treatment effect and the <code>sandwich</code> package’s estimate should be equivalent:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"treatment effect variance unchanged by regression adjustment"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">a22inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="op">(</span></span>
<span>      <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b12</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b12</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b11</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">a21</span><span class="op">)</span></span>
<span>     <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a22inv</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>    <span class="va">a22inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="op">(</span></span>
<span>      <span class="va">b22</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b12</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b12</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="va">a21</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b11</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a11inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">a21</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">a22inv</span>,</span>
<span>    <span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">damod</span>,</span>
<span>                       meat <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span>,</span>
<span>                       cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>,</span>
<span>                       cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                       type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 🥳</span></span></code></pre>
<p>Still, since we’ve generated <span class="math inline">\(y\)</span> such that there are no heterogeneous effects, then asymptotically (and, barring an unlikely sample of enough data points, in a simulated finite sample), covariance adjustment obtained from a model fit to only the control observations should reduce the unexplained variation to the same degree as a model that simultaneously estimates the effects of the treatment and covariates. Then, covariance adjustment’s increase of the available degrees of freedom for variance estimation should result in a smaller variance estimate for the treatment effect than that from the larger model:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"flexida has smaller variance estimate than big model"</span>, <span class="op">{</span></span>
<span>  <span class="va">onemod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="op">(</span><span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">*</span><span class="va">z</span>, data <span class="op">=</span> <span class="va">df</span>, weights <span class="op">=</span> <span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">onemod</span>,</span>
<span>                                 meat <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span>,</span>
<span>                                 cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>,</span>
<span>                                 cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                 type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&gt;</span></span>
<span>                <span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 🎊</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="validation-when-matched-pairs-are-not-identical">Validation When Matched Pairs Are Not Identical<a class="anchor" aria-label="anchor" href="#validation-when-matched-pairs-are-not-identical"></a>
</h4>
<p>Now, suppose we have data where matched pairs are not comprised of identical clusters. Note that we change the covariate values of a single data point in each treated cluster so the coefficients estimated by the covariance model remain the same as before. As a result, we would only expect modifications to <span class="math inline">\(A_{21}\)</span>, and <span class="math inline">\(B_{22}\)</span> in <code>flexida</code> (and <code>geex</code>’s) variance calculation:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">uid</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">uid</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">z</span>, <span class="va">df</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">theta</span> <span class="op">+</span> <span class="va">eps</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x1_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            </span></span>
<span><span class="co">##             x1_0 x1_1</span></span>
<span><span class="co">##   cluster_1   32    8</span></span>
<span><span class="co">##   cluster_2   30   10</span></span>
<span><span class="co">##   cluster_3    8   12</span></span>
<span><span class="co">##   cluster_4    7   13</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x2_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            </span></span>
<span><span class="co">##             x2_0 x2_1</span></span>
<span><span class="co">##   cluster_1   20   20</span></span>
<span><span class="co">##   cluster_2   18   22</span></span>
<span><span class="co">##   cluster_3   12    8</span></span>
<span><span class="co">##   cluster_4   11    9</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">cmod_form</span>, <span class="va">df</span><span class="op">[</span><span class="va">ctrl_idx</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/Design_objects.html">rct_design</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="fu"><a href="../../reference/DesignSpecials.html">cluster</a></span><span class="op">(</span><span class="va">cid</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">damod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/as_lmitt.html">as.lmitt</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">damod_form</span>, data <span class="op">=</span> <span class="va">df</span>, weights <span class="op">=</span> <span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fu"><a href="../../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="va">onemod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="op">(</span><span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">*</span><span class="va">z</span>, data <span class="op">=</span> <span class="va">df</span>, weights <span class="op">=</span> <span class="fu"><a href="../../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"only A21 and B22 change from before"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a11_inverse</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span>, <span class="va">a11inv</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a21</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">a21</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a21</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span> <span class="op">!=</span> <span class="va">a21</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_a22_inverse</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span>, <span class="va">a22inv</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b11</a></span><span class="op">(</span><span class="va">damod</span>, type <span class="op">=</span> <span class="st">"HC0"</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="va">b11</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b12</a></span><span class="op">(</span><span class="va">damod</span><span class="op">)</span>, <span class="va">b12</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b22</a></span><span class="op">(</span><span class="va">damod</span>, type <span class="op">=</span> <span class="st">"HC0"</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">b22</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="../../reference/sandwich_elements_calc.html">.get_b22</a></span><span class="op">(</span><span class="va">damod</span>, type <span class="op">=</span> <span class="st">"HC0"</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">!=</span> <span class="va">b22</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 😀</span></span></code></pre>
<p><code>flexida</code>’s estimated variance of the treatment effect estimate should be larger than the <code>sandwich</code> package’s, since <span class="math inline">\(A_{22}^{-1}A_{21} \neq 0\)</span> in this case. It should still be equivalent to the <code>geex</code> package, however, and the comparison to the larger model mentioned in the previous section should, in all likelihood, hold:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"regression adjustment increases estimated variance"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&gt;</span></span>
<span>      <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">damod</span>,</span>
<span>                         meat <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span>,</span>
<span>                         cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>,</span>
<span>                         cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">geexRes</span> <span class="op">&lt;-</span> <span class="fu">geex</span><span class="fu">::</span><span class="fu"><a href="https://bsaul.github.io/geex/reference/m_estimate.html" class="external-link">m_estimate</a></span><span class="op">(</span></span>
<span>    <span class="va">estFunc</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"weight"</span> <span class="op">=</span> <span class="va">damod</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span>,</span>
<span>    units <span class="op">=</span> <span class="st">"cid"</span>,</span>
<span>    root_control <span class="op">=</span> <span class="fu">geex</span><span class="fu">::</span><span class="fu"><a href="https://bsaul.github.io/geex/reference/setup_root_control.html" class="external-link">setup_root_control</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="va">p</span> <span class="op">+</span> <span class="va">q</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    outer_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cmod_form <span class="op">=</span> <span class="va">geex_cmod_form</span>,</span>
<span>                      damod_form <span class="op">=</span> <span class="va">geex_damod_form</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, type <span class="op">=</span> <span class="st">"HC0"</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>               <span class="va">geexRes</span><span class="op">@</span><span class="va">vcov</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/sandwich.html" class="external-link">sandwich</a></span><span class="op">(</span><span class="va">onemod</span>,</span>
<span>                                 meat <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">meatCL</a></span>,</span>
<span>                                 cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">cid</span><span class="op">)</span>,</span>
<span>                                 cadjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                 type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&gt;</span></span>
<span>                <span class="fu"><a href="../../reference/vcovDA.html">vcovDA</a></span><span class="op">(</span><span class="va">damod</span>, cadjust <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"HC0"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">Test passed</span> 🌈</span></span></code></pre>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
