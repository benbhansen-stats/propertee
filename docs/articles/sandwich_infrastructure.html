<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="flexida">
<title>Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model • flexida</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model">
<meta property="og:description" content="flexida">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">flexida</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/CovarianceAdjustment.html">Covariance Adjustment for Randomized Trials</a>
    <a class="dropdown-item" href="../articles/LinearModelVarianceEstimation.html">Variance Estimation Testing Using A Simple Linear Specification</a>
    <a class="dropdown-item" href="../articles/RDD.html">Regression Discontinuity Designs</a>
    <a class="dropdown-item" href="../articles/design_based_SEs.html">Design based sandwich SEs for differences of Hajek estimators</a>
    <a class="dropdown-item" href="../articles/not-for-cran/non-binary-weights.html">Non-Binary Treatment</a>
    <a class="dropdown-item" href="../articles/sandwich_infrastructure.html">Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/benbhansen-stats/flexida/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Data structures to support standard error calculations for direct adjustment assisted by a prior covariance model</h1>
                        <h4 data-toc-skip class="author">Ben Hansen</h4>
            
            <h4 data-toc-skip class="date">April 2022 (+ non-substantive updates in May ’22)</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/benbhansen-stats/flexida/blob/HEAD/vignettes/sandwich_infrastructure.Rmd" class="external-link"><code>vignettes/sandwich_infrastructure.Rmd</code></a></small>
      <div class="d-none name"><code>sandwich_infrastructure.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="context">Context<a class="anchor" aria-label="anchor" href="#context"></a>
</h2>
<p>The user has specified a comparative study design and separately fitted a covariance model. E.g.:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Design_objects.html">obs_design</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="fu">strata</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/DesignSpecials.html">cluster</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">classroom</span><span class="op">)</span>,</span>
<span>                  data <span class="op">=</span><span class="va">Q_</span><span class="op">)</span></span>
<span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">promotion</span> <span class="op">~</span> <span class="va">pretest</span> <span class="op">+</span> <span class="va">gender</span>,</span>
<span>            family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">C</span><span class="op">)</span></span></code></pre></div>
<p>The data frames <code>C</code> and <code>Q_</code> describe the covariance and quasiexperimental samples, potentially at different levels of aggregation. For instance <code>C</code> might give student data while <code>Q_</code> is a table of classrooms. The samples they describe may be disjoint, identical or overlapping.</p>
<p>Next she uses <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> (or perhaps an <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>-wrapper we’ll offer) to calculate directly adjusted<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Much or all of what’s said here can later be made to apply with intention-to-treat models of nearby forms, for example &lt;code&gt;lm(promotion ~ treat + cov_adj(covmod), data=Q, weights=ate(des))&lt;/code&gt; or &lt;code&gt;lm(promotion ~ treat * cov_adj(covmod), &amp;lt;...&amp;gt;)&lt;/code&gt;. But for now our focus is covariance modeling followed by direct adjustment, ie what’s shown in the display.&lt;/p&gt;"><sup>1</sup></a> estimates of an intention-to-treat effect:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">promotion</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">gender</span>, data <span class="op">=</span> <span class="va">Q</span>,</span>
<span>        offset <span class="op">=</span> <span class="fu"><a href="../reference/cov_adj.html">cov_adj</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span>,</span>
<span>        weights <span class="op">=</span> <span class="fu"><a href="../reference/WeightCreators.html">ate</a></span><span class="op">(</span><span class="va">des</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="co"># spits out effect estimates</span></span></code></pre></div>
<p>where <code>Q</code> may be the same as <code>Q_</code>, or <code>Q_</code> may describe aggregates of units described in <code>Q</code>; the offset is similar to what <code>predict(cmod, newdata=Q, type="response")</code> would have given; and the weights are of the Horwitz-Thompson, inverse probability of assignment type.</p>
<p>At this point <code>m</code> has class <code>lm</code>, but with additional information tucked away in <code>m[['model']]</code>: this data frame will have special columns <code>(weights)</code> and <code>offset(cov_adj(cmod))</code>. As of this writing, the flexida package implements an S4 class <code>WeightedDesign</code> that extends the base numeric vector type and encodes information beyond unit weights necessary for standard error calculations, and arranges that <code>m[['model']][['(weights)']]</code> is of this type. This note describes two planned classes appropriate for <code>m[['model']][['offset(cov_adj(cmod))']]</code>: <code>SandwichLayer</code>, and a fallback option <code>PreSandwichLayer</code>, for use when the call to <code><a href="../reference/cov_adj.html">cov_adj()</a></code> producing this object is able to locate some but not all of the necessary information.</p>
<p>Standard errors will be obtained through subsequent steps, e.g. </p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_lmitt.html">as.DirectAdjusted</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_lmitt.html">as.DirectAdjusted</a></span><span class="op">(</span><span class="va">m</span>,</span>
<span>                       by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cmod<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>cid1<span class="op">=</span><span class="va">altcid1</span>, cid2<span class="op">=</span><span class="va">altcid2</span><span class="op">)</span><span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>with “<code>cid1</code>” and “<code>cid2</code>” the column names of <code>clusters(des)</code>, while <code>altcid1</code> and <code>altcid2</code> corresponding column names of <code>C</code>, or</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_lmitt.html">as.DirectAdjusted</a></span><span class="op">(</span><span class="va">m</span>,</span>
<span>                       by<span class="op">=</span><span class="va">keys_data_frame</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>where <code>keys_data_frame</code> has rows aligned with those of <code>C</code> and columns including “<code>cid1</code>” and “<code>cid2</code>.”</p>
<p>Either way, once <code>m</code> has been coerced to class <code>DirectAdjusted</code>, it has acquired a <code>@Design</code> slot for the information in <code>des</code>, while <code>m[['model']]</code> will have a column <code>offset(cov_adj(cmod))</code> of class <code>SandwichLayer</code>. Together these objects will contain the necessary additional information to perform standard error calculations that:</p>
<ul>
<li>attend to the structure of the design, as recorded in <code>des</code>; and</li>
<li>propagate errors from the fitting of covariance model <code>cmod</code> into standard errors reported for <code>treat * gender</code> coefficients.</li>
</ul>
</div>
<div class="section level2">
<h2 id="formal-class-structure-proposal">Formal class structure proposal<a class="anchor" aria-label="anchor" href="#formal-class-structure-proposal"></a>
</h2>
<!-- couldn't get the below to render properly-->
<!-- Rendering from https://mermaid.live/ -->
<p><img src="images/sandwich_layers.png"></p>
<p>Like the existing class <code>WeightedDesign</code>, the <code>PreSandwichLayer</code> and <code>SandwichLayer</code> classes extend the base numeric vector type, with numeric vectors (of predictions) in their <code>@.Data</code> slots. <code>PreSandwichLayer</code> and <code>SandwichLayer</code> also have a <code>@prediction_gradient</code> slot, for a numeric matrix of dimension</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">nrow</span>(<span class="sc">@</span>.Data), <span class="fu">length</span>(<span class="fu">coef</span>(fitted_covariance_model)))</span></code></pre></div>
<p>Regarding <code><a href="../reference/as.SandwichLayer.html">as.SandwichLayer()</a></code>: Turning a <code>PreSandwichLayer</code>, <code>x</code>, into a <code>SandwichLayer</code> amounts to providing a mapping from the rows of <code>model.matrix(x)</code> or <code>sandwich::estfun(x)</code> to units of assignment recorded in <code>des</code>. This mapping is to be recorded the <code>@keys</code> data frame, with as many rows as <code>model.matrix(x)</code> and as many columns as there are unit-of-assignment (clustering) variables in a corresponding <code>Design</code>.</p>
<p>The mapping can be effected via <code>expand.model.frame(x, vars, &lt;...&gt;)</code>. If <code>by=NULL</code>, then <code>vars</code> is the vector of names of unit-of-assignment variables given in the <code>design</code>, <code>desvars</code> say. Otherwise <code>by</code> is a named character vector giving a crosswalk, the second argument to <code><a href="https://rdrr.io/r/stats/expand.model.frame.html" class="external-link">expand.model.frame()</a></code> should be <code>by[desvars]</code>, and those names should be switched out of column names inthe data frame <code><a href="https://rdrr.io/r/stats/expand.model.frame.html" class="external-link">expand.model.frame()</a></code> returns in favor of <code>desvars</code>.</p>
<p>In order for <code>vcov.DirectAdjusted(m)</code> to work, the following functions must have methods applicable to <code>m@fitted_covariance_model</code>: <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>, <code><a href="https://sandwich.R-Forge.R-project.org/reference/estfun.html" class="external-link">sandwich::estfun()</a></code>, <code><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">sandwich::bread()</a></code>. These are similar requirements to those of <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="basis-in-known-extensions-of-huber-white-setup-to-chained-estimators">Basis in known extensions of Huber-White setup to chained estimators<a class="anchor" aria-label="anchor" href="#basis-in-known-extensions-of-huber-white-setup-to-chained-estimators"></a>
</h2>
<p>With reference to the formulas for stacked estimating equations of Carroll, Ruppert, Stefanski and Crainiceanu (2006, p.373), the covariance model has psi functions (estimating equations) <span class="math inline">\(\phi(\tilde{\mathbf{Y}}, \alpha)\)</span> with parameters <span class="math inline">\(\alpha\)</span>, and Fisher information and estimating-equation covariance matrices <span class="math inline">\(A_{11}\)</span> and <span class="math inline">\(B_{11}\)</span> respectively; while the direct adjustment model’s are <span class="math inline">\(\psi(\tilde{\mathbf{Y}}, \tau, \alpha)\)</span>, the <code>treat</code> coefficients being <span class="math inline">\(\tau\)</span>, with sandwich components <span class="math inline">\(A_{22}\)</span> and <span class="math inline">\(B_{22}\)</span>. (The symbols “<span class="math inline">\(\phi()\)</span>,” “<span class="math inline">\(\psi()\)</span>” and “<span class="math inline">\(\alpha\)</span>” are used as Carroll et al use them, while our “<span class="math inline">\(\tau\)</span>” corresponds to their “<span class="math inline">\(\mathcal{B}\)</span>.”)</p>
<p>We take <span class="math inline">\(i\)</span> to range over the units of assignment (clusters) not elements<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We’ll need to aggregate (by summing) the elementwise estimating equation contributions to the cluster level, to form cluster-wise estimating equation contributions.&lt;/p&gt;"><sup>2</sup></a>. The Carroll et al development is missing <span class="math inline">\(n^{-1}\)</span> factors at the right of the equations defining <span class="math inline">\(A_{n,\, 11}, \ldots, B_{n,\, 22}\)</span>. To avoid ambiguities in mapping to external subroutines’ understanding of “<span class="math inline">\(n\)</span>”<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Carroll et al seem to have a single sample in mind, without clusters, whereas we have both &lt;span class="math inline"&gt;\(\mathcal{C}\)&lt;/span&gt; and &lt;span class="math inline"&gt;\(\mathcal{Q}\)&lt;/span&gt;, with or without clusters. Where necessary, we use &lt;span class="math inline"&gt;\(n_\mathcal{C}\)&lt;/span&gt; and &lt;span class="math inline"&gt;\(n_\mathcal{Q}\)&lt;/span&gt; for the unit-of-assignment counts in the two samples respectively.&lt;/p&gt;'><sup>3</sup></a>, let’s address the error by leaving those displays as-is, while striking the leading <span class="math inline">\(n^{-1}\)</span> factors from display (A.34) and from the subsequent expression for <span class="math inline">\(\mathrm{var}(\hat{\mathcal{B}})\)</span>: i.e., turn the A and B matrices into sums not means. Carroll et al’s formulas for <span class="math inline">\(A_{11}\)</span>, <span class="math inline">\(A_{21}\)</span> and <span class="math inline">\(A_{22}\)</span> then apply, although design-based standard errors call for different calculations of <span class="math inline">\(B_{11}\)</span>, <span class="math inline">\(B_{12}\)</span> and <span class="math inline">\(B_{22}\)</span>. (When we get around to putting the multidecker sandwich together, we’ll need to be cognizant of the fact that its As and Bs are means not sums, and ready to compensate for the fact that it will have divided by different <span class="math inline">\(ns\)</span> in figuring the means that are <span class="math inline">\(A_{11}\)</span> and <span class="math inline">\(A_{22}\)</span>, for example.) Denote the clusters/units of assignment that are represented in covariance and quasiexperimental samples by <span class="math inline">\(\mathcal{C}\)</span> and <span class="math inline">\(\mathcal{Q}\)</span> respectively.</p>
</div>
<div class="section level2">
<h2 id="required-materials-for-se-calculations">Required materials for SE calculations<a class="anchor" aria-label="anchor" href="#required-materials-for-se-calculations"></a>
</h2>
<p>To estimate variances and covariances of <span class="math inline">\(\tau\)</span>, we’ll need to assemble the following materials.</p>
<ol style="list-style-type: decimal">
<li>Sufficient information about <span class="math inline">\(\mathcal{C}\)</span> and <span class="math inline">\(\mathcal{Q}\)</span> to identify their intersection <span class="math inline">\(\mathcal{C}\cap\mathcal{Q}\)</span>, as is needed to estimate <span class="math inline">\(B_{21}\)</span>;</li>
<li>Matrices of estimating functions <span class="math inline">\(\{\phi(\tilde{\mathbf{Y}}_i; \hat{\alpha}): i \in \mathcal{C}\cap\mathcal{Q}\}\)</span> and <span class="math inline">\(\{\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, \hat{\alpha}): i \in \mathcal{C}\cap\mathcal{Q}\}\)</span>, as are needed for <span class="math inline">\(B_{21}\)</span>;</li>
<li>For the quasiexperimental sample <span class="math inline">\(\mathcal{Q}\)</span>, matrices <span class="math display">\[\nabla_{\alpha} \{\sum_{j \in i}\psi(\tilde{\mathbf{Y}}_j, \hat{\tau}, {\alpha}):
i \in \mathcal{Q}\} \vert_{\alpha=\hat\alpha},\]</span> corresponding to <span class="math inline">\(A_{21}\)</span>, where “<span class="math inline">\(j \in i\)</span>” means “elements <span class="math inline">\(j\)</span> of cluster <span class="math inline">\(i\)</span>” and “<span class="math inline">\(\sum_{j \in i} \psi(\tilde{\mathbf{Y}}_j, \hat{\tau}, {\alpha})\)</span>” is interpreted to mean “<span class="math inline">\(\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, {\alpha})\)</span>” if there is no clustering;</li>
<li>Estimates of the direct adjustment model’s “bread matrix” <span class="math inline">\((n_\mathcal{Q}^{-1} A_{22})^{-1} = \{\frac{1}{\# \mathcal{Q}}\nabla_\tau \sum_{i \in \mathcal{Q}} \mathbb{E}[\psi(\tilde{\mathbf{Y}}_i, \tau, \hat{\alpha})] \vert_{\tau=\hat\tau}\}^{-1}\)</span>, i.e. the inverse of its Fisher information w.r.t. <span class="math inline">\(\tau\)</span> only, along with the “meat matrix” <span class="math inline">\(n_\mathcal{Q}^{-1} B_{22} = n_\mathcal{Q}^{-1} \mathrm{Cov}[\sum_{i \in \mathcal{Q}} \psi(\tilde{\mathbf{Y}}_i, {\tau}, {\alpha})]_{({\tau}, {\alpha})=(\hat{\tau}, \hat{\alpha})}\)</span>;</li>
<li>The covariance model’s bread matrix <span class="math inline">\((n_\mathcal{C}^{-1} \hat{A}_{11})^{-1} = \{n_\mathcal{C}^{-1}\sum_{i \in \mathcal{C}} \nabla_\alpha [\phi(\tilde{\mathbf{Y}}_i; {\alpha})]_{\alpha=\hat\alpha}\}^{-1}\)</span>; and</li>
<li>for covariance estimation in the conventional “model-based” setup only, estimates of the covariance model’s B matrix <span class="math inline">\(n_\mathcal{C}^{-1}B_{11} = n_\mathcal{C}^{-1} \mathrm{Cov}[\sum_{i \in \mathcal{C}}\phi(\tilde{\mathbf{Y}}_i; {\alpha})]_{\alpha=\hat\alpha}\)</span> (a “clustered” covariance estimate).</li>
</ol>
<p>In (5), observed information <span class="math inline">\(n_\mathcal{C}^{-1}\sum_{i \in \mathcal{C}} \nabla_\alpha [\phi(\tilde{\mathbf{Y}}_i; {\alpha})]_{\alpha=\hat\alpha}\)</span> is preferred to “observed expected” information, <span class="math inline">\(n_\mathcal{C}^{-1}\sum_{i \in \mathcal{C}} \nabla_\alpha \mathbb{E} [\phi(\tilde{\mathbf{Y}}_i; {\alpha})]_{\alpha=\hat\alpha}\)</span>, because observed information is agnostic as to whether expectation is calculated with conditioning on potential outcomes, ie the finite population perspective, or with conditioning on treatment assignment, the model based perspective. In the special case of quantile regression<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Strictly speaking, the estimating equations of a quantile regression aren’t differentiable in &lt;span class="math inline"&gt;\(\alpha\)&lt;/span&gt;. All directional derivatives will exist, and I’m expecting this to be enough for our purposes, but I haven’t thought it through.&lt;/p&gt;'><sup>4</sup></a>, observed information isn’t ordinarily used in standard error calculations, and it may take some doing to get.</p>
<p>Regarding (6), <span class="math inline">\(B_{11}\)</span> is not needed for design-based standard errors, as in this setting observations outside of the quasiexperimental sample do not contribute to the covariance model’s B matrix. Only quasiexperimental sample observations do, and we’ll have access to these when the direct adjustment model is fit. As we also have <span class="math inline">\(\{\phi(\tilde{\mathbf{Y}}_i; \hat{\alpha}): i \in \mathcal{Q}\}\)</span> and <span class="math inline">\(\{\psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, \hat{\alpha}): i \in \mathcal{Q}\}\)</span>, we can use these materials to estimate <span class="math inline">\(B_{12}\)</span> and <span class="math inline">\(B_{22}\)</span>.</p>
</div>
<div class="section level2">
<h2 id="software-implementation-comments-on-16-above-including-contents-of-sandwichveganlayerlayerkit-objects">Software implementation comments on 1–6 above, including contents of {<code>Sandwich</code>/<code>Vegan</code>}{<code>Layer</code>/<code>LayerKit</code>} objects<a class="anchor" aria-label="anchor" href="#software-implementation-comments-on-16-above-including-contents-of-sandwichveganlayerlayerkit-objects"></a>
</h2>
<p>1. A <code>SandwichLayer</code> object <code>s_l_o</code> carries a <code>keys</code> data frame with which to identify rows of <code>model.matrix(s_l_o)</code> with units of assignment (as named in a separate Design object). The association can be many-one (but not one-many); it is not required that named units appear in the design. As <code>covmod</code> itself won’t be aware of these cluster associations, assembling this info at runtime calls for trickery, as well as a means for users to override the trickery and directly provide key variables that the design will need. An NA in <code>keys</code> indicates a unit not appearing in the Design.</p>
<p>2. Estimating functions may need to be aggregated (summed) to the cluster level before calculation of <span class="math inline">\(B_{21}\)</span>. There should be a dedicated function to calculate <span class="math inline">\(B_{21}\)</span> from the cluster-aggregated estimating function matrices.</p>
<p>3. <code>PreSandwichLayer</code> and <code>SandwichLayer</code> have an <code>@prediction_gradient</code> slot for a numeric matrix. This matrix has as many rows as there are entries in the <code>.Data</code> vector, and as many columns as there are estimating equations.</p>
<p>The <code>@prediction_gradient</code> slot carries <span class="math inline">\(\{\nabla_\alpha f_{\alpha}(\tilde{\mathbf{Y}}_j)|_\alpha=\hat\alpha\}\)</span>, where <span class="math inline">\(j\)</span> ranges over rows of <code>Q</code> as above – elements not clusters where the distinction exists – and <span class="math inline">\(f_\alpha(\mathbf{Y})\)</span> represents the prediction for data <span class="math inline">\(\mathbf{Y}\)</span> from a fitted model of <code>class(cov_mod)</code> with parameters <span class="math inline">\(\alpha\)</span>. For <span class="math inline">\(\psi()\)</span>’s that use only “predictions” of the covariance model, as ours does, the first derivative of the covariance model predictions as applied to data in <span class="math inline">\(\mathcal{Q}\)</span> will provide sufficient information from the covariance model to complete the calculation of <span class="math inline">\(\{\nabla_{\alpha} \psi(\tilde{\mathbf{Y}}_i, \hat{\tau}, {\alpha}) \vert_{\alpha=\hat\alpha}: i \in \mathcal{Q}\}\)</span>.</p>
<p>For <code>glm</code> and similarly typed objects <code>cmod</code>, such predictions are a joint function of <code>family(cmod)</code> and the <code>model.matrix</code> generated in the process of creating predictions from <code>cmod</code>.</p>
<p>4. The <code>SandwichLayer</code> class isn’t implicated in (4). We can take extant calculations of a direct adjustment model’s information matrix, with the proviso that we keep track of whatever scaling those calculations may have applied. For design-based SEs we’ll need our own B matrix calculation. For model-based SEs we can plug in to extant routines for <span class="math inline">\(B_{22}\)</span> also, but being careful ensure clustering on the units of assignment (as named in a Design object). Scaling of these matrices should default to the conventions of the sandwich package. (I haven’t considered whether use of HC0–3 etc for <span class="math inline">\(B_{22}\)</span> calls for corresponding adjustment to estimation of <span class="math inline">\(B_{21}\)</span> and/or <span class="math inline">\(B_{11}\)</span>, nor whether heuristics animating these adjustments make sense in this context.)</p>
<p>5. <code><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">sandwich::bread()</a></code> will be used to retrieve <span class="math inline">\(A_{11}^{-1}\)</span>.</p>
<p>We can take extant calculations of a covariance model’s information matrix, defaulting to scaling conventions implemented in the sandwich package.</p>
<p>6. <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">sandwich::meatCL()</a></code> will be used to retrieve <span class="math inline">\(B_{11}\)</span>. For now we only try to implement HC0 &amp; HC1. (I haven’t considered whether use of HC0–3 etc for <span class="math inline">\(B_{11}\)</span> calls for corresponding adjustment to estimation of <span class="math inline">\(B_{21}\)</span> and/or <span class="math inline">\(B_{22}\)</span>, nor whether heuristics animating these adjustments make sense in this context.)</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
